<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>10.&nbsp;Spring AOP APIs</title><link rel="stylesheet" type="text/css" href="css/manual-multipage.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Spring Framework Reference Documentation"><link rel="up" href="spring-core.html" title="Part&nbsp;III.&nbsp;&#26680;&#24515;&#25216;&#26415;"><link rel="prev" href="aop.html" title="9.&nbsp;Aspect Oriented Programming with Spring"><link rel="next" href="spring-data-tier.html" title="Part&nbsp;IV.&nbsp;&#25968;&#25454;&#35775;&#38382;"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">


<!-- Copyright � 2005. Spidersoft Ltd -->
<style>
A.applink:hover {border: 2px dotted #DCE6F4;padding:2px;background-color:#ffff00;color:green;text-decoration:none}
A.applink       {border: 2px dotted #DCE6F4;padding:2px;color:#2F5BFF;background:transparent;text-decoration:none}
A.info          {color:#2F5BFF;background:transparent;text-decoration:none}
A.info:hover    {color:green;background:transparent;text-decoration:underline}
</style>
<!-- <div style='BORDER: 1px solid #DCE6F4; MARGIN-TOP: 20px; MARGIN-BOTTOM: 20px; MARGIN-LEFT: 5px; MARGIN-RIGHT: 5px; PADDING: 5px; BACKGROUND-COLOR: #eef8ff;line-height:180%; COLOR: #000000; font-family: Arial; font-size: 8pt; width=100%; FILTER: progid:DXImageTransform.Microsoft.Gradient(GradientType=0, StartColorStr="#FFFFFFFF", EndColorStr="#F2F5FAFF");'>
This page was saved using <a class="applink" href="http://www.spidersoft.com"><b>WebZIP 7.0.3.1030</b></a> <a class="applink" href="http://www.spidersoft.com"><b>offline browser</b></a>  (Unregistered) on  07/15/15 15:58:57.<br>
<b>Address:</b> <a class="info" href="http://itmyhome.com/spring/aop-api.html">http://itmyhome.com/spring/aop-api.html</a><br>
<b>Title:</b> 10.&nbsp;Spring AOP APIs &nbsp;&bull;&nbsp; <b>Size:</b> 398577 &nbsp;&bull;&nbsp; <b>Last Modified:</b> Sat, 11 Apr 2015 20:39:28 GMT<br></div>
<!-- /Copyright � 2005. Spidersoft Ltd -->

<div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">10.&nbsp;Spring AOP APIs</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="aop.html">Prev</a>&nbsp;</td><th width="60%" align="center">Part&nbsp;III.&nbsp;&#26680;&#24515;&#25216;&#26415;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="spring-data-tier.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="aop-api" href="#aop-api"></a>10.&nbsp;Spring AOP APIs</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-introduction" href="#aop-api-introduction"></a>10.1&nbsp;Introduction</h2></div></div></div>

<p>The previous chapter described the Spring&#8217;s support for AOP using
@AspectJ and schema-based aspect definitions. In this chapter we discuss the lower-level
Spring AOP APIs and the AOP support used in Spring 1.2 applications. For new
applications, we recommend the use of the Spring 2.0 and later AOP support described in
the previous chapter, but when working with existing applications, or when reading books
and articles, you may come across Spring 1.2 style examples. Spring 4.0 is backwards
compatible with Spring 1.2 and everything described in this chapter is fully supported
in Spring 4.0.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-pointcuts" href="#aop-api-pointcuts"></a>10.2&nbsp;Pointcut API in Spring</h2></div></div></div>

<p>Let&#8217;s look at how Spring handles the crucial pointcut concept.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-concepts" href="#aop-api-concepts"></a>10.2.1&nbsp;Concepts</h3></div></div></div>

<p>Spring&#8217;s pointcut model enables pointcut reuse independent of advice types. It&#8217;s
possible to target different advice using the same pointcut.</p>
<p>The <code class="literal">org.springframework.aop.Pointcut</code> interface is the central interface, used to
target advices to particular classes and methods. The complete interface is shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Pointcut {

    ClassFilter getClassFilter();

    MethodMatcher getMethodMatcher();

}</pre>

<p>Splitting the <code class="literal">Pointcut</code> interface into two parts allows reuse of class and method
matching parts, and fine-grained composition operations (such as performing a "union"
with another method matcher).</p>
<p>The <code class="literal">ClassFilter</code> interface is used to restrict the pointcut to a given set of target
classes. If the <code class="literal">matches()</code> method always returns true, all target classes will be
matched:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> ClassFilter {

    <span class="hl-keyword">boolean</span> matches(Class clazz);
}</pre>

<p>The <code class="literal">MethodMatcher</code> interface is normally more important. The complete interface is
shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodMatcher {

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass);

    <span class="hl-keyword">boolean</span> isRuntime();

    <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass, Object[] args);
}</pre>

<p>The <code class="literal">matches(Method, Class)</code> method is used to test whether this pointcut will ever
match a given method on a target class. This evaluation can be performed when an AOP
proxy is created, to avoid the need for a test on every method invocation. If the
2-argument matches method returns true for a given method, and the <code class="literal">isRuntime()</code> method
for the MethodMatcher returns true, the 3-argument matches method will be invoked on
every method invocation. This enables a pointcut to look at the arguments passed to the
method invocation immediately before the target advice is to execute.</p>
<p>Most MethodMatchers are static, meaning that their <code class="literal">isRuntime()</code> method returns false.
In this case, the 3-argument matches method will never be invoked.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If possible, try to make pointcuts static, allowing the AOP framework to cache the
results of pointcut evaluation when an AOP proxy is created.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcut-ops" href="#aop-api-pointcut-ops"></a>10.2.2&nbsp;Operations on pointcuts</h3></div></div></div>

<p>Spring supports operations on pointcuts: notably, <span class="emphasis"><em>union</em></span> and <span class="emphasis"><em>intersection</em></span>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Union means the methods that either pointcut matches.
</li><li class="listitem">
Intersection means the methods that both pointcuts match.
</li><li class="listitem">
Union is usually more useful.
</li><li class="listitem">
Pointcuts can be composed using the static methods in the
<span class="emphasis"><em>org.springframework.aop.support.Pointcuts</em></span> class, or using the
<span class="emphasis"><em>ComposablePointcut</em></span> class in the same package. However, using AspectJ pointcut
expressions is usually a simpler approach.
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-aspectj" href="#aop-api-pointcuts-aspectj"></a>10.2.3&nbsp;AspectJ expression pointcuts</h3></div></div></div>

<p>Since 2.0, the most important type of pointcut used by Spring is
<code class="literal">org.springframework.aop.aspectj.AspectJExpressionPointcut</code>. This is a pointcut that
uses an AspectJ supplied library to parse an AspectJ pointcut expression string.</p>
<p>See the previous chapter for a discussion of supported AspectJ pointcut primitives.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-impls" href="#aop-api-pointcuts-impls"></a>10.2.4&nbsp;Convenience pointcut implementations</h3></div></div></div>

<p>Spring provides several convenient pointcut implementations. Some can be used out of the
box; others are intended to be subclassed in application-specific pointcuts.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-pointcuts-static" href="#aop-api-pointcuts-static"></a>Static pointcuts</h4></div></div></div>

<p>Static pointcuts are based on method and target class, and cannot take into account the
method&#8217;s arguments. Static pointcuts are sufficient - <span class="emphasis"><em>and best</em></span> - for most usages.
It&#8217;s possible for Spring to evaluate a static pointcut only once, when a method is first
invoked: after that, there is no need to evaluate the pointcut again with each method
invocation.</p>
<p>Let&#8217;s consider some static pointcut implementations included with Spring.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-regex" href="#aop-api-pointcuts-regex"></a>Regular expression pointcuts</h5></div></div></div>

<p>One obvious way to specify static pointcuts is regular expressions. Several AOP
frameworks besides Spring make this possible.
<code class="literal">org.springframework.aop.support.JdkRegexpMethodPointcut</code> is a generic regular
expression pointcut, using the regular expression support in JDK 1.4+.</p>
<p>Using the <code class="literal">JdkRegexpMethodPointcut</code> class, you can provide a list of pattern Strings. If
any of these is a match, the pointcut will evaluate to true. (So the result is
effectively the union of these pointcuts.)</p>
<p>The usage is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulatePointcut"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.JdkRegexpMethodPointcut"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*set.*<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Spring provides a convenience class, <code class="literal">RegexpMethodPointcutAdvisor</code>, that allows us to
also reference an Advice (remember that an Advice can be an interceptor, before advice,
throws advice etc.). Behind the scenes, Spring will use a <code class="literal">JdkRegexpMethodPointcut</code>.
Using <code class="literal">RegexpMethodPointcutAdvisor</code> simplifies wiring, as the one bean encapsulates both
pointcut and advice, as shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"settersAndAbsquatulateAdvisor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.RegexpMethodPointcutAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"advice"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"beanNameOfAopAllianceInterceptor"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"patterns"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*set.*<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>.*absquatulate<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p><span class="emphasis"><em>RegexpMethodPointcutAdvisor</em></span> can be used with any Advice type.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-attribute-driven" href="#aop-api-pointcuts-attribute-driven"></a>Attribute-driven pointcuts</h5></div></div></div>

<p>An important type of static pointcut is a <span class="emphasis"><em>metadata-driven</em></span> pointcut. This uses the
values of metadata attributes: typically, source-level metadata.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-pointcuts-dynamic" href="#aop-api-pointcuts-dynamic"></a>Dynamic pointcuts</h4></div></div></div>

<p>Dynamic pointcuts are costlier to evaluate than static pointcuts. They take into account
method <span class="emphasis"><em>arguments</em></span>, as well as static information. This means that they must be
evaluated with every method invocation; the result cannot be cached, as arguments will
vary.</p>
<p>The main example is the <code class="literal">control flow</code> pointcut.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="aop-api-pointcuts-cflow" href="#aop-api-pointcuts-cflow"></a>Control flow pointcuts</h5></div></div></div>

<p>Spring control flow pointcuts are conceptually similar to AspectJ <span class="emphasis"><em>cflow</em></span> pointcuts,
although less powerful. (There is currently no way to specify that a pointcut executes
below a join point matched by another pointcut.) A control flow pointcut matches the
current call stack. For example, it might fire if the join point was invoked by a method
in the <code class="literal">com.mycompany.web</code> package, or by the <code class="literal">SomeCaller</code> class. Control flow pointcuts
are specified using the <code class="literal">org.springframework.aop.support.ControlFlowPointcut</code> class.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Control flow pointcuts are significantly more expensive to evaluate at runtime than even
other dynamic pointcuts. In Java 1.4, the cost is about 5 times that of other dynamic
pointcuts.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-superclasses" href="#aop-api-pointcuts-superclasses"></a>10.2.5&nbsp;Pointcut superclasses</h3></div></div></div>

<p>Spring provides useful pointcut superclasses to help you to implement your own pointcuts.</p>
<p>Because static pointcuts are most useful, you&#8217;ll probably subclass
StaticMethodMatcherPointcut, as shown below. This requires implementing just one
abstract method (although it&#8217;s possible to override other methods to customize behavior):</p>
<pre class="programlisting"><span class="hl-keyword">class</span> TestStaticPointcut <span class="hl-keyword">extends</span> StaticMethodMatcherPointcut {

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> matches(Method m, Class targetClass) {
        <span class="hl-comment">// return true if custom criteria match</span>
    }
}</pre>

<p>There are also superclasses for dynamic pointcuts.</p>
<p>You can use custom pointcuts with any advice type in Spring 1.0 RC2 and above.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-pointcuts-custom" href="#aop-api-pointcuts-custom"></a>10.2.6&nbsp;Custom pointcuts</h3></div></div></div>

<p>Because pointcuts in Spring AOP are Java classes, rather than language features (as in
AspectJ) it&#8217;s possible to declare custom pointcuts, whether static or dynamic. Custom
pointcuts in Spring can be arbitrarily complex. However, using the AspectJ pointcut
expression language is recommended if possible.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Later versions of Spring may offer support for "semantic pointcuts" as offered by JAC:
for example, "all methods that change instance variables in the target object."</p>
</td></tr></table></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advice" href="#aop-api-advice"></a>10.3&nbsp;Advice API in Spring</h2></div></div></div>

<p>Let&#8217;s now look at how Spring AOP handles advice.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-advice-lifecycle" href="#aop-api-advice-lifecycle"></a>10.3.1&nbsp;Advice lifecycles</h3></div></div></div>

<p>Each advice is a Spring bean. An advice instance can be shared across all advised
objects, or unique to each advised object. This corresponds to <span class="emphasis"><em>per-class</em></span> or
<span class="emphasis"><em>per-instance</em></span> advice.</p>
<p>Per-class advice is used most often. It is appropriate for generic advice such as
transaction advisors. These do not depend on the state of the proxied object or add new
state; they merely act on the method and arguments.</p>
<p>Per-instance advice is appropriate for introductions, to support mixins. In this case,
the advice adds state to the proxied object.</p>
<p>It&#8217;s possible to use a mix of shared and per-instance advice in the same AOP proxy.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-advice-types" href="#aop-api-advice-types"></a>10.3.2&nbsp;Advice types in Spring</h3></div></div></div>

<p>Spring provides several advice types out of the box, and is extensible to support
arbitrary advice types. Let us look at the basic concepts and standard advice types.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-around" href="#aop-api-advice-around"></a>Interception around advice</h4></div></div></div>

<p>The most fundamental advice type in Spring is <span class="emphasis"><em>interception around advice</em></span>.</p>
<p>Spring is compliant with the AOP Alliance interface for around advice using method
interception. MethodInterceptors implementing around advice should implement the
following interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodInterceptor <span class="hl-keyword">extends</span> Interceptor {

    Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>The <code class="literal">MethodInvocation</code> argument to the <code class="literal">invoke()</code> method exposes the method being
invoked; the target join point; the AOP proxy; and the arguments to the method. The
<code class="literal">invoke()</code> method should return the invocation&#8217;s result: the return value of the join
point.</p>
<p>A simple <code class="literal">MethodInterceptor</code> implementation looks as follows:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DebugInterceptor <span class="hl-keyword">implements</span> MethodInterceptor {

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        System.out.println(<span class="hl-string">"Before: invocation=["</span> + invocation + <span class="hl-string">"]"</span>);
        Object rval = invocation.proceed();
        System.out.println(<span class="hl-string">"Invocation returned"</span>);
        <span class="hl-keyword">return</span> rval;
    }
}</pre>

<p>Note the call to the MethodInvocation&#8217;s <code class="literal">proceed()</code> method. This proceeds down the
interceptor chain towards the join point. Most interceptors will invoke this method, and
return its return value. However, a MethodInterceptor, like any around advice, can
return a different value or throw an exception rather than invoke the proceed method.
However, you don&#8217;t want to do this without good reason!</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>MethodInterceptors offer interoperability with other AOP Alliance-compliant AOP
implementations. The other advice types discussed in the remainder of this section
implement common AOP concepts, but in a Spring-specific way. While there is an advantage
in using the most specific advice type, stick with MethodInterceptor around advice if
you are likely to want to run the aspect in another AOP framework. Note that pointcuts
are not currently interoperable between frameworks, and the AOP Alliance does not
currently define pointcut interfaces.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-before" href="#aop-api-advice-before"></a>Before advice</h4></div></div></div>

<p>A simpler advice type is a <span class="emphasis"><em>before advice</em></span>. This does not need a <code class="literal">MethodInvocation</code>
object, since it will only be called before entering the method.</p>
<p>The main advantage of a before advice is that there is no need to invoke the <code class="literal">proceed()</code>
method, and therefore no possibility of inadvertently failing to proceed down the
interceptor chain.</p>
<p>The <code class="literal">MethodBeforeAdvice</code> interface is shown below. (Spring&#8217;s API design would allow for
field before advice, although the usual objects apply to field interception and it&#8217;s
unlikely that Spring will ever implement it).</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> MethodBeforeAdvice <span class="hl-keyword">extends</span> BeforeAdvice {

    <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>Note the return type is <code class="literal">void</code>. Before advice can insert custom behavior before the join
point executes, but cannot change the return value. If a before advice throws an
exception, this will abort further execution of the interceptor chain. The exception
will propagate back up the interceptor chain. If it is unchecked, or on the signature of
the invoked method, it will be passed directly to the client; otherwise it will be
wrapped in an unchecked exception by the AOP proxy.</p>
<p>An example of a before advice in Spring, which counts all method invocations:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingBeforeAdvice <span class="hl-keyword">implements</span> MethodBeforeAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> before(Method m, Object[] args, Object target) <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Before advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-throws" href="#aop-api-advice-throws"></a>Throws advice</h4></div></div></div>

<p><span class="emphasis"><em>Throws advice</em></span> is invoked after the return of the join point if the join point threw
an exception. Spring offers typed throws advice. Note that this means that the
<code class="literal">org.springframework.aop.ThrowsAdvice</code> interface does not contain any methods: It is a
tag interface identifying that the given object implements one or more typed throws
advice methods. These should be in the form of:</p>
<pre class="programlisting">afterThrowing([Method, args, target], subclassOfThrowable)</pre>

<p>Only the last argument is required. The method signatures may have either one or four
arguments, depending on whether the advice method is interested in the method and
arguments. The following classes are examples of throws advice.</p>
<p>The advice below is invoked if a <code class="literal">RemoteException</code> is thrown (including subclasses):</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> RemoteThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }
}</pre>

<p>The following advice is invoked if a <code class="literal">ServletException</code> is thrown. Unlike the above
advice, it declares 4 arguments, so that it has access to the invoked method, method
arguments and target object:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ServletThrowsAdviceWithArguments <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<p>The final example illustrates how these two methods could be used in a single class,
which handles both <code class="literal">RemoteException</code> and <code class="literal">ServletException</code>. Any number of throws advice
methods can be combined in a single class.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> CombinedThrowsAdvice <span class="hl-keyword">implements</span> ThrowsAdvice {

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(RemoteException ex) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-comment">// Do something with remote exception</span>
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterThrowing(Method m, Object[] args, Object target, ServletException ex) {
        <span class="hl-comment">// Do something with all arguments</span>
    }
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If a throws-advice method throws an exception itself, it will override the
original exception (i.e. change the exception thrown to the user). The overriding
exception will typically be a RuntimeException; this is compatible with any method
signature. However, if a throws-advice method throws a checked exception, it will have
to match the declared exceptions of the target method and is hence to some degree
coupled to specific target method signatures. <span class="emphasis"><em>Do not throw an undeclared checked
exception that is incompatible with the target method&#8217;s signature!</em></span></p>
</td></tr></table></div>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Throws advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-after-returning" href="#aop-api-advice-after-returning"></a>After Returning advice</h4></div></div></div>

<p>An after returning advice in Spring must implement the
<span class="emphasis"><em>org.springframework.aop.AfterReturningAdvice</em></span> interface, shown below:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> AfterReturningAdvice <span class="hl-keyword">extends</span> Advice {

    <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args, Object target)
            <span class="hl-keyword">throws</span> Throwable;
}</pre>

<p>An after returning advice has access to the return value (which it cannot modify),
invoked method, methods arguments and target.</p>
<p>The following after returning advice counts all successful method invocations that have
not thrown exceptions:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CountingAfterReturningAdvice <span class="hl-keyword">implements</span> AfterReturningAdvice {

    <span class="hl-keyword">private</span> <span class="hl-keyword">int</span> count;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterReturning(Object returnValue, Method m, Object[] args, Object target)
            <span class="hl-keyword">throws</span> Throwable {
        ++count;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">int</span> getCount() {
        <span class="hl-keyword">return</span> count;
    }
}</pre>

<p>This advice doesn&#8217;t change the execution path. If it throws an exception, this will be
thrown up the interceptor chain instead of the return value.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>After returning advice can be used with any pointcut.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-advice-introduction" href="#aop-api-advice-introduction"></a>Introduction advice</h4></div></div></div>

<p>Spring treats introduction advice as a special kind of interception advice.</p>
<p>Introduction requires an <code class="literal">IntroductionAdvisor</code>, and an <code class="literal">IntroductionInterceptor</code>,
implementing the following interface:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInterceptor <span class="hl-keyword">extends</span> MethodInterceptor {

    <span class="hl-keyword">boolean</span> implementsInterface(Class intf);
}</pre>

<p>The <code class="literal">invoke()</code> method inherited from the AOP Alliance <code class="literal">MethodInterceptor</code> interface must
implement the introduction: that is, if the invoked method is on an introduced
interface, the introduction interceptor is responsible for handling the method call - it
cannot invoke <code class="literal">proceed()</code>.</p>
<p>Introduction advice cannot be used with any pointcut, as it applies only at class,
rather than method, level. You can only use introduction advice with the
<code class="literal">IntroductionAdvisor</code>, which has the following methods:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionAdvisor <span class="hl-keyword">extends</span> Advisor, IntroductionInfo {

    ClassFilter getClassFilter();

    <span class="hl-keyword">void</span> validateInterfaces() <span class="hl-keyword">throws</span> IllegalArgumentException;
}

<span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> IntroductionInfo {

    Class[] getInterfaces();
}</pre>

<p>There is no <code class="literal">MethodMatcher</code>, and hence no <code class="literal">Pointcut</code>, associated with introduction
advice. Only class filtering is logical.</p>
<p>The <code class="literal">getInterfaces()</code> method returns the interfaces introduced by this advisor.</p>
<p>The <code class="literal">validateInterfaces()</code> method is used internally to see whether or not the
introduced interfaces can be implemented by the configured <code class="literal">IntroductionInterceptor</code>.</p>
<p>Let&#8217;s look at a simple example from the Spring test suite. Let&#8217;s suppose we want to
introduce the following interface to one or more objects:</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">interface</span> Lockable {
    <span class="hl-keyword">void</span> lock();
    <span class="hl-keyword">void</span> unlock();
    <span class="hl-keyword">boolean</span> locked();
}</pre>

<p>This illustrates a <span class="emphasis"><em>mixin</em></span>. We want to be able to cast advised objects to Lockable,
whatever their type, and call lock and unlock methods. If we call the lock() method, we
want all setter methods to throw a <code class="literal">LockedException</code>. Thus we can add an aspect that
provides the ability to make objects immutable, without them having any knowledge of it:
a good example of AOP.</p>
<p>Firstly, we&#8217;ll need an <code class="literal">IntroductionInterceptor</code> that does the heavy lifting. In this
case, we extend the <code class="literal">org.springframework.aop.support.DelegatingIntroductionInterceptor</code>
convenience class. We could implement IntroductionInterceptor directly, but using
<code class="literal">DelegatingIntroductionInterceptor</code> is best for most cases.</p>
<p>The <code class="literal">DelegatingIntroductionInterceptor</code> is designed to delegate an introduction to an
actual implementation of the introduced interface(s), concealing the use of interception
to do so. The delegate can be set to any object using a constructor argument; the
default delegate (when the no-arg constructor is used) is this. Thus in the example
below, the delegate is the <code class="literal">LockMixin</code> subclass of <code class="literal">DelegatingIntroductionInterceptor</code>.
Given a delegate (by default itself), a <code class="literal">DelegatingIntroductionInterceptor</code> instance
looks for all interfaces implemented by the delegate (other than
IntroductionInterceptor), and will support introductions against any of them. It&#8217;s
possible for subclasses such as <code class="literal">LockMixin</code> to call the <code class="literal">suppressInterface(Class intf)</code>
method to suppress interfaces that should not be exposed. However, no matter how many
interfaces an <code class="literal">IntroductionInterceptor</code> is prepared to support, the
<code class="literal">IntroductionAdvisor</code> used will control which interfaces are actually exposed. An
introduced interface will conceal any implementation of the same interface by the target.</p>
<p>Thus <code class="literal">LockMixin</code> extends <code class="literal">DelegatingIntroductionInterceptor</code> and implements <code class="literal">Lockable</code>
itself. The superclass automatically picks up that Lockable can be supported for
introduction, so we don&#8217;t need to specify that. We could introduce any number of
interfaces in this way.</p>
<p>Note the use of the <code class="literal">locked</code> instance variable. This effectively adds additional state
to that held in the target object.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixin <span class="hl-keyword">extends</span> DelegatingIntroductionInterceptor <span class="hl-keyword">implements</span> Lockable {

    <span class="hl-keyword">private</span> <span class="hl-keyword">boolean</span> locked;

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> lock() {
        <span class="hl-keyword">this</span>.locked = true;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> unlock() {
        <span class="hl-keyword">this</span>.locked = false;
    }

    <span class="hl-keyword">public</span> <span class="hl-keyword">boolean</span> locked() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">this</span>.locked;
    }

    <span class="hl-keyword">public</span> Object invoke(MethodInvocation invocation) <span class="hl-keyword">throws</span> Throwable {
        <span class="hl-keyword">if</span> (locked() &amp;&amp; invocation.getMethod().getName().indexOf(<span class="hl-string">"set"</span>) == <span class="hl-number">0</span>) {
            <span class="hl-keyword">throw</span> <span class="hl-keyword">new</span> LockedException();
        }
        <span class="hl-keyword">return</span> <span class="hl-keyword">super</span>.invoke(invocation);
    }

}</pre>

<p>Often it isn&#8217;t necessary to override the <code class="literal">invoke()</code> method: the
<code class="literal">DelegatingIntroductionInterceptor</code> implementation - which calls the delegate method if
the method is introduced, otherwise proceeds towards the join point - is usually
sufficient. In the present case, we need to add a check: no setter method can be invoked
if in locked mode.</p>
<p>The introduction advisor required is simple. All it needs to do is hold a distinct
<code class="literal">LockMixin</code> instance, and specify the introduced interfaces - in this case, just
<code class="literal">Lockable</code>. A more complex example might take a reference to the introduction
interceptor (which would be defined as a prototype): in this case, there&#8217;s no
configuration relevant for a <code class="literal">LockMixin</code>, so we simply create it using <code class="literal">new</code>.</p>
<pre class="programlisting"><span class="hl-keyword">public</span> <span class="hl-keyword">class</span> LockMixinAdvisor <span class="hl-keyword">extends</span> DefaultIntroductionAdvisor {

    <span class="hl-keyword">public</span> LockMixinAdvisor() {
        <span class="hl-keyword">super</span>(<span class="hl-keyword">new</span> LockMixin(), Lockable.<span class="hl-keyword">class</span>);
    }
}</pre>

<p>We can apply this advisor very simply: it requires no configuration. (However, it <span class="emphasis"><em>is</em></span>
necessary: It&#8217;s impossible to use an <code class="literal">IntroductionInterceptor</code> without an
<span class="emphasis"><em>IntroductionAdvisor</em></span>.) As usual with introductions, the advisor must be per-instance,
as it is stateful. We need a different instance of <code class="literal">LockMixinAdvisor</code>, and hence
<code class="literal">LockMixin</code>, for each advised object. The advisor comprises part of the advised object&#8217;s
state.</p>
<p>We can apply this advisor programmatically, using the <code class="literal">Advised.addAdvisor()</code> method, or
(the recommended way) in XML configuration, like any other advisor. All proxy creation
choices discussed below, including "auto proxy creators," correctly handle introductions
and stateful mixins.</p>
</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advisor" href="#aop-api-advisor"></a>10.4&nbsp;Advisor API in Spring</h2></div></div></div>

<p>In Spring, an Advisor is an aspect that contains just a single advice object associated
with a pointcut expression.</p>
<p>Apart from the special case of introductions, any advisor can be used with any advice.
<code class="literal">org.springframework.aop.support.DefaultPointcutAdvisor</code> is the most commonly used
advisor class. For example, it can be used with a <code class="literal">MethodInterceptor</code>, <code class="literal">BeforeAdvice</code> or
<code class="literal">ThrowsAdvice</code>.</p>
<p>It is possible to mix advisor and advice types in Spring in the same AOP proxy. For
example, you could use a interception around advice, throws advice and before advice in
one proxy configuration: Spring will automatically create the necessary interceptor
chain.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-pfb" href="#aop-pfb"></a>10.5&nbsp;Using the ProxyFactoryBean to create AOP proxies</h2></div></div></div>

<p>If you&#8217;re using the Spring IoC container (an ApplicationContext or BeanFactory) for your
business objects - and you should be! - you will want to use one of Spring&#8217;s AOP
FactoryBeans. (Remember that a factory bean introduces a layer of indirection, enabling
it to create objects of a different type.)</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The Spring AOP support also uses factory beans under the covers.</p>
</td></tr></table></div>

<p>The basic way to create an AOP proxy in Spring is to use the
<span class="emphasis"><em>org.springframework.aop.framework.ProxyFactoryBean</em></span>. This gives complete control over
the pointcuts and advice that will apply, and their ordering. However, there are simpler
options that are preferable if you don&#8217;t need such control.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-1" href="#aop-pfb-1"></a>10.5.1&nbsp;Basics</h3></div></div></div>

<p>The <code class="literal">ProxyFactoryBean</code>, like other Spring <code class="literal">FactoryBean</code> implementations, introduces a
level of indirection. If you define a <code class="literal">ProxyFactoryBean</code> with name <code class="literal">foo</code>, what objects
referencing <code class="literal">foo</code> see is not the <code class="literal">ProxyFactoryBean</code> instance itself, but an object
created by the <code class="literal">ProxyFactoryBean</code>'s implementation of the <code class="literal">getObject()</code> method. This
method will create an AOP proxy wrapping a target object.</p>
<p>One of the most important benefits of using a <code class="literal">ProxyFactoryBean</code> or another IoC-aware
class to create AOP proxies, is that it means that advices and pointcuts can also be
managed by IoC. This is a powerful feature, enabling certain approaches that are hard to
achieve with other AOP frameworks. For example, an advice may itself reference
application objects (besides the target, which should be available in any AOP
framework), benefiting from all the pluggability provided by Dependency Injection.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-2" href="#aop-pfb-2"></a>10.5.2&nbsp;JavaBean properties</h3></div></div></div>

<p>In common with most <code class="literal">FactoryBean</code> implementations provided with Spring, the
<code class="literal">ProxyFactoryBean</code> class is itself a JavaBean. Its properties are used to:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Specify the target you want to proxy.
</li><li class="listitem">
Specify whether to use CGLIB (see below and also <a class="xref" href="http://itmyhome.com/spring/aop-api.html#aop-pfb-proxy-types" title="10.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;10.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li></ul></div>

<p>Some key properties are inherited from <code class="literal">org.springframework.aop.framework.ProxyConfig</code>
(the superclass for all AOP proxy factories in Spring). These key properties include:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">proxyTargetClass</code>: <code class="literal">true</code> if the target class is to be proxied, rather than the
target class' interfaces. If this property value is set to <code class="literal">true</code>, then CGLIB proxies
will be created (but see also <a class="xref" href="http://itmyhome.com/spring/aop-api.html#aop-pfb-proxy-types" title="10.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;10.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<code class="literal">optimize</code>: controls whether or not aggressive optimizations are applied to proxies
<span class="emphasis"><em>created via CGLIB</em></span>. One should not blithely use this setting unless one fully
understands how the relevant AOP proxy handles optimization. This is currently used
only for CGLIB proxies; it has no effect with JDK dynamic proxies.
</li><li class="listitem">
<code class="literal">frozen</code>: if a proxy configuration is <code class="literal">frozen</code>, then changes to the configuration are
no longer allowed. This is useful both as a slight optimization and for those cases
when you don&#8217;t want callers to be able to manipulate the proxy (via the <code class="literal">Advised</code>
interface) after the proxy has been created. The default value of this property is
<code class="literal">false</code>, so changes such as adding additional advice are allowed.
</li><li class="listitem">
<code class="literal">exposeProxy</code>: determines whether or not the current proxy should be exposed in a
<code class="literal">ThreadLocal</code> so that it can be accessed by the target. If a target needs to obtain
the proxy and the <code class="literal">exposeProxy</code> property is set to <code class="literal">true</code>, the target can use the
<code class="literal">AopContext.currentProxy()</code> method.
</li></ul></div>

<p>Other properties specific to <code class="literal">ProxyFactoryBean</code> include:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">proxyInterfaces</code>: array of String interface names. If this isn&#8217;t supplied, a CGLIB
proxy for the target class will be used (but see also <a class="xref" href="http://itmyhome.com/spring/aop-api.html#aop-pfb-proxy-types" title="10.5.3&nbsp;JDK- and CGLIB-based proxies">Section&nbsp;10.5.3, &#8220;JDK- and CGLIB-based proxies&#8221;</a>).
</li><li class="listitem">
<code class="literal">interceptorNames</code>: String array of <code class="literal">Advisor</code>, interceptor or other advice names to
apply. Ordering is significant, on a first come-first served basis. That is to say
that the first interceptor in the list will be the first to be able to intercept the
invocation.
</li></ul></div>

<p>The names are bean names in the current factory, including bean names from ancestor
factories. You can&#8217;t mention bean references here since doing so would result in the
<code class="literal">ProxyFactoryBean</code> ignoring the singleton setting of the advice.</p>
<p>You can append an interceptor name with an asterisk ( <code class="literal">*</code>). This will result in the
application of all advisor beans with names starting with the part before the asterisk
to be applied. An example of using this feature can be found in <a class="xref" href="http://itmyhome.com/spring/aop-api.html#aop-global-advisors" title="10.5.6&nbsp;Using global advisors">Section&nbsp;10.5.6, &#8220;Using <span class="emphasis"><em>global</em></span> advisors&#8221;</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
singleton: whether or not the factory should return a single object, no matter how
often the <code class="literal">getObject()</code> method is called. Several <code class="literal">FactoryBean</code> implementations offer
such a method. The default value is <code class="literal">true</code>. If you want to use stateful advice - for
example, for stateful mixins - use prototype advices along with a singleton value of
<code class="literal">false</code>.
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-pfb-proxy-types" href="#aop-pfb-proxy-types"></a>10.5.3&nbsp;JDK- and CGLIB-based proxies</h3></div></div></div>

<p>This section serves as the definitive documentation on how the <code class="literal">ProxyFactoryBean</code>
chooses to create one of either a JDK- and CGLIB-based proxy for a particular target
object (that is to be proxied).</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>The behavior of the <code class="literal">ProxyFactoryBean</code> with regard to creating JDK- or CGLIB-based
proxies changed between versions 1.2.x and 2.0 of Spring. The <code class="literal">ProxyFactoryBean</code> now
exhibits similar semantics with regard to auto-detecting interfaces as those of the
<code class="literal">TransactionProxyFactoryBean</code> class.</p>
</td></tr></table></div>

<p>If the class of a target object that is to be proxied (hereafter simply referred to as
the target class) doesn&#8217;t implement any interfaces, then a CGLIB-based proxy will be
created. This is the easiest scenario, because JDK proxies are interface based, and no
interfaces means JDK proxying isn&#8217;t even possible. One simply plugs in the target bean,
and specifies the list of interceptors via the <code class="literal">interceptorNames</code> property. Note that a
CGLIB-based proxy will be created even if the <code class="literal">proxyTargetClass</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">false</code>. (Obviously this makes no sense, and is best
removed from the bean definition because it is at best redundant, and at worst
confusing.)</p>
<p>If the target class implements one (or more) interfaces, then the type of proxy that is
created depends on the configuration of the <code class="literal">ProxyFactoryBean</code>.</p>
<p>If the <code class="literal">proxyTargetClass</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to <code class="literal">true</code>,
then a CGLIB-based proxy will be created. This makes sense, and is in keeping with the
principle of least surprise. Even if the <code class="literal">proxyInterfaces</code> property of the
<code class="literal">ProxyFactoryBean</code> has been set to one or more fully qualified interface names, the fact
that the <code class="literal">proxyTargetClass</code> property is set to <code class="literal">true</code> <span class="emphasis"><em>will</em></span> cause CGLIB-based
proxying to be in effect.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has been set to one or more
fully qualified interface names, then a JDK-based proxy will be created. The created
proxy will implement all of the interfaces that were specified in the <code class="literal">proxyInterfaces</code>
property; if the target class happens to implement a whole lot more interfaces than
those specified in the <code class="literal">proxyInterfaces</code> property, that is all well and good but those
additional interfaces will not be implemented by the returned proxy.</p>
<p>If the <code class="literal">proxyInterfaces</code> property of the <code class="literal">ProxyFactoryBean</code> has <span class="emphasis"><em>not</em></span> been set, but
the target class <span class="emphasis"><em>does implement one (or more)</em></span> interfaces, then the
<code class="literal">ProxyFactoryBean</code> will auto-detect the fact that the target class does actually
implement at least one interface, and a JDK-based proxy will be created. The interfaces
that are actually proxied will be <span class="emphasis"><em>all</em></span> of the interfaces that the target class
implements; in effect, this is the same as simply supplying a list of each and every
interface that the target class implements to the <code class="literal">proxyInterfaces</code> property. However,
it is significantly less work, and less prone to typos.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-proxying-intf" href="#aop-api-proxying-intf"></a>10.5.4&nbsp;Proxying interfaces</h3></div></div></div>

<p>Let&#8217;s look at a simple example of <code class="literal">ProxyFactoryBean</code> in action. This example involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A <span class="emphasis"><em>target bean</em></span> that will be proxied. This is the "personTarget" bean definition in
the example below.
</li><li class="listitem">
An Advisor and an Interceptor used to provide advice.
</li><li class="listitem">
An AOP proxy bean definition specifying the target object (the personTarget bean) and
the interfaces to proxy, along with the advices to apply.
</li></ul></div>

<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Tony"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"51"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Custom string property value"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span>
    <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycompany.Person"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"personTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the <code class="literal">interceptorNames</code> property takes a list of String: the bean names of the
interceptor or advisors in the current factory. Advisors, interceptors, before, after
returning and throws advice objects can be used. The ordering of advisors is significant.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>You might be wondering why the list doesn&#8217;t hold bean references. The reason for this is
that if the ProxyFactoryBean&#8217;s singleton property is set to false, it must be able to
return independent proxy instances. If any of the advisors is itself a prototype, an
independent instance would need to be returned, so it&#8217;s necessary to be able to obtain
an instance of the prototype from the factory; holding a reference isn&#8217;t sufficient.</p>
</td></tr></table></div>

<p>The "person" bean definition above can be used in place of a Person implementation, as
follows:</p>
<pre class="programlisting">Person person = (Person) factory.getBean(<span class="hl-string">"person"</span>);</pre>

<p>Other beans in the same IoC context can express a strongly typed dependency on it, as
with an ordinary Java object:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"personUser"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonUser"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"person"</span><span class="hl-tag">&gt;</span><span class="hl-tag">&lt;ref</span> <span class="hl-attribute">bean</span>=<span class="hl-value">"person"</span><span class="hl-tag">/&gt;</span><span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">PersonUser</code> class in this example would expose a property of type Person. As far as
it&#8217;s concerned, the AOP proxy can be used transparently in place of a "real" person
implementation. However, its class would be a dynamic proxy class. It would be possible
to cast it to the <code class="literal">Advised</code> interface (discussed below).</p>
<p>It&#8217;s possible to conceal the distinction between target and proxy using an anonymous
<span class="emphasis"><em>inner bean</em></span>, as follows. Only the <code class="literal">ProxyFactoryBean</code> definition is different; the
advice is included only for completeness:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"someProperty"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Custom string property value"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"debugInterceptor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"person"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"proxyInterfaces"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"com.mycompany.Person"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-comment">&lt;!-- Use inner bean, not local reference to target --&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.PersonImpl"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"name"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"Tony"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"age"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"51"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myAdvisor<span class="hl-tag">&lt;/value&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>debugInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This has the advantage that there&#8217;s only one object of type <code class="literal">Person</code>: useful if we want
to prevent users of the application context from obtaining a reference to the un-advised
object, or need to avoid any ambiguity with Spring IoC <span class="emphasis"><em>autowiring</em></span>. There&#8217;s also
arguably an advantage in that the ProxyFactoryBean definition is self-contained.
However, there are times when being able to obtain the un-advised target from the
factory might actually be an <span class="emphasis"><em>advantage</em></span>: for example, in certain test scenarios.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-api-proxying-class" href="#aop-api-proxying-class"></a>10.5.5&nbsp;Proxying classes</h3></div></div></div>

<p>What if you need to proxy a class, rather than one or more interfaces?</p>
<p>Imagine that in our example above, there was no <code class="literal">Person</code> interface: we needed to advise
a class called <code class="literal">Person</code> that didn&#8217;t implement any business interface. In this case, you
can configure Spring to use CGLIB proxying, rather than dynamic proxies. Simply set the
<code class="literal">proxyTargetClass</code> property on the ProxyFactoryBean above to true. While it&#8217;s best to
program to interfaces, rather than classes, the ability to advise classes that don&#8217;t
implement interfaces can be useful when working with legacy code. (In general, Spring
isn&#8217;t prescriptive. While it makes it easy to apply good practices, it avoids forcing a
particular approach.)</p>
<p>If you want to, you can force the use of CGLIB in any case, even if you do have
interfaces.</p>
<p>CGLIB proxying works by generating a subclass of the target class at runtime. Spring
configures this generated subclass to delegate method calls to the original target: the
subclass is used to implement the <span class="emphasis"><em>Decorator</em></span> pattern, weaving in the advice.</p>
<p>CGLIB proxying should generally be transparent to users. However, there are some issues
to consider:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">Final</code> methods can&#8217;t be advised, as they can&#8217;t be overridden.
</li><li class="listitem">
There is no need to add CGLIB to your classpath. As of Spring 3.2, CGLIB is repackaged
and included in the spring-core JAR. In other words, CGLIB-based AOP will work "out of
the box" just as do JDK dynamic proxies.
</li></ul></div>

<p>There&#8217;s little performance difference between CGLIB proxying and dynamic proxies. As of
Spring 1.0, dynamic proxies are slightly faster. However, this may change in the future.
Performance should not be a decisive consideration in this case.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-global-advisors" href="#aop-global-advisors"></a>10.5.6&nbsp;Using <span class="emphasis"><em>global</em></span> advisors</h3></div></div></div>

<p>By appending an asterisk to an interceptor name, all advisors with bean names matching
the part before the asterisk, will be added to the advisor chain. This can come in handy
if you need to add a standard set of <span class="emphasis"><em>global</em></span> advisors:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"proxy"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"service"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>global*<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_debug"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.DebugInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"global_performance"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.interceptor.PerformanceMonitorInterceptor"</span><span class="hl-tag">/&gt;</span></pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-concise-proxy" href="#aop-concise-proxy"></a>10.6&nbsp;Concise proxy definitions</h2></div></div></div>

<p>Especially when defining transactional proxies, you may end up with many similar proxy
definitions. The use of parent and child bean definitions, along with inner bean
definitions, can result in much cleaner and more concise proxy definitions.</p>
<p>First a parent, <span class="emphasis"><em>template</em></span>, bean definition is created for the proxy:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"txProxyTemplate"</span> <span class="hl-attribute">abstract</span>=<span class="hl-value">"true"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This will never be instantiated itself, so may actually be incomplete. Then each proxy
which needs to be created is just a child bean definition, which wraps the target of the
proxy as an inner bean definition, since the target will never be used on its own anyway.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"myService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MyServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>It is of course possible to override properties from the parent template, such as in
this case, the transaction propagation settings:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"mySpecialService"</span> <span class="hl-attribute">parent</span>=<span class="hl-value">"txProxyTemplate"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"target"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.samples.MySpecialServiceImpl"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributes"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;props&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"get*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"find*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"load*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED,readOnly<span class="hl-tag">&lt;/prop&gt;</span>
            <span class="hl-tag">&lt;prop</span> <span class="hl-attribute">key</span>=<span class="hl-value">"store*"</span><span class="hl-tag">&gt;</span>PROPAGATION_REQUIRED<span class="hl-tag">&lt;/prop&gt;</span>
        <span class="hl-tag">&lt;/props&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that in the example above, we have explicitly marked the parent bean definition as
<span class="emphasis"><em>abstract</em></span> by using the <span class="emphasis"><em>abstract</em></span> attribute, as described
<a class="link" href="http://itmyhome.com/spring/beans.html#beans-child-bean-definitions" title="5.7&nbsp;Bean definition inheritance">previously</a>, so that it may not actually ever be
instantiated. Application contexts (but not simple bean factories) will by default
pre-instantiate all singletons. It is therefore important (at least for singleton beans)
that if you have a (parent) bean definition which you intend to use only as a template,
and this definition specifies a class, you must make sure to set the <span class="emphasis"><em>abstract</em></span>
attribute to <span class="emphasis"><em>true</em></span>, otherwise the application context will actually try to
pre-instantiate it.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-prog" href="#aop-prog"></a>10.7&nbsp;Creating AOP proxies programmatically with the ProxyFactory</h2></div></div></div>

<p>It&#8217;s easy to create AOP proxies programmatically using Spring. This enables you to use
Spring AOP without dependency on Spring IoC.</p>
<p>The following listing shows creation of a proxy for a target object, with one
interceptor and one advisor. The interfaces implemented by the target object will
automatically be proxied:</p>
<pre class="programlisting">ProxyFactory factory = <span class="hl-keyword">new</span> ProxyFactory(myBusinessInterfaceImpl);
factory.addAdvice(myMethodInterceptor);
factory.addAdvisor(myAdvisor);
MyBusinessInterface tb = (MyBusinessInterface) factory.getProxy();</pre>

<p>The first step is to construct an object of type
<code class="literal">org.springframework.aop.framework.ProxyFactory</code>. You can create this with a target
object, as in the above example, or specify the interfaces to be proxied in an alternate
constructor.</p>
<p>You can add advices (with interceptors as a specialized kind of advice) and/or advisors,
and manipulate them for the life of the ProxyFactory. If you add an
IntroductionInterceptionAroundAdvisor, you can cause the proxy to implement additional
interfaces.</p>
<p>There are also convenience methods on ProxyFactory (inherited from <code class="literal">AdvisedSupport</code>)
which allow you to add other advice types such as before and throws advice.
AdvisedSupport is the superclass of both ProxyFactory and ProxyFactoryBean.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>Integrating AOP proxy creation with the IoC framework is best practice in most
applications. We recommend that you externalize configuration from Java code with AOP,
as in general.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-advised" href="#aop-api-advised"></a>10.8&nbsp;Manipulating advised objects</h2></div></div></div>

<p>However you create AOP proxies, you can manipulate them using the
<code class="literal">org.springframework.aop.framework.Advised</code> interface. Any AOP proxy can be cast to this
interface, whichever other interfaces it implements. This interface includes the
following methods:</p>
<pre class="programlisting">Advisor[] getAdvisors();

<span class="hl-keyword">void</span> addAdvice(Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvice(<span class="hl-keyword">int</span> pos, Advice advice) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> addAdvisor(<span class="hl-keyword">int</span> pos, Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">int</span> indexOf(Advisor advisor);

<span class="hl-keyword">boolean</span> removeAdvisor(Advisor advisor) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">void</span> removeAdvisor(<span class="hl-keyword">int</span> index) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> replaceAdvisor(Advisor a, Advisor b) <span class="hl-keyword">throws</span> AopConfigException;

<span class="hl-keyword">boolean</span> isFrozen();</pre>

<p>The <code class="literal">getAdvisors()</code> method will return an Advisor for every advisor, interceptor or
other advice type that has been added to the factory. If you added an Advisor, the
returned advisor at this index will be the object that you added. If you added an
interceptor or other advice type, Spring will have wrapped this in an advisor with a
pointcut that always returns true. Thus if you added a <code class="literal">MethodInterceptor</code>, the advisor
returned for this index will be an <code class="literal">DefaultPointcutAdvisor</code> returning your
<code class="literal">MethodInterceptor</code> and a pointcut that matches all classes and methods.</p>
<p>The <code class="literal">addAdvisor()</code> methods can be used to add any Advisor. Usually the advisor holding
pointcut and advice will be the generic <code class="literal">DefaultPointcutAdvisor</code>, which can be used with
any advice or pointcut (but not for introductions).</p>
<p>By default, it&#8217;s possible to add or remove advisors or interceptors even once a proxy
has been created. The only restriction is that it&#8217;s impossible to add or remove an
introduction advisor, as existing proxies from the factory will not show the interface
change. (You can obtain a new proxy from the factory to avoid this problem.)</p>
<p>A simple example of casting an AOP proxy to the <code class="literal">Advised</code> interface and examining and
manipulating its advice:</p>
<pre class="programlisting">Advised advised = (Advised) myObject;
Advisor[] advisors = advised.getAdvisors();
<span class="hl-keyword">int</span> oldAdvisorCount = advisors.length;
System.out.println(oldAdvisorCount + <span class="hl-string">" advisors"</span>);

<span class="hl-comment">// Add an advice like an interceptor without a pointcut</span>
<span class="hl-comment">// Will match all proxied methods</span>
<span class="hl-comment">// Can use for interceptors, before, after returning or throws advice</span>
advised.addAdvice(<span class="hl-keyword">new</span> DebugInterceptor());

<span class="hl-comment">// Add selective advice using a pointcut</span>
advised.addAdvisor(<span class="hl-keyword">new</span> DefaultPointcutAdvisor(mySpecialPointcut, myAdvice));

assertEquals(<span class="hl-string">"Added two advisors"</span>, oldAdvisorCount + <span class="hl-number">2</span>, advised.getAdvisors().length);</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>It&#8217;s questionable whether it&#8217;s advisable (no pun intended) to modify advice on a
business object in production, although there are no doubt legitimate usage cases.
However, it can be very useful in development: for example, in tests. I have sometimes
found it very useful to be able to add test code in the form of an interceptor or other
advice, getting inside a method invocation I want to test. (For example, the advice can
get inside a transaction created for that method: for example, to run SQL to check that
a database was correctly updated, before marking the transaction for roll back.)</p>
</td></tr></table></div>

<p>Depending on how you created the proxy, you can usually set a <code class="literal">frozen</code> flag, in which
case the <code class="literal">Advised</code> <code class="literal">isFrozen()</code> method will return true, and any attempts to modify
advice through addition or removal will result in an <code class="literal">AopConfigException</code>. The ability
to freeze the state of an advised object is useful in some cases, for example, to
prevent calling code removing a security interceptor. It may also be used in Spring 1.1
to allow aggressive optimization if runtime advice modification is known not to be
required.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-autoproxy" href="#aop-autoproxy"></a>10.9&nbsp;Using the "auto-proxy" facility</h2></div></div></div>

<p>So far we&#8217;ve considered explicit creation of AOP proxies using a <code class="literal">ProxyFactoryBean</code> or
similar factory bean.</p>
<p>Spring also allows us to use "auto-proxy" bean definitions, which can automatically
proxy selected bean definitions. This is built on Spring "bean post processor"
infrastructure, which enables modification of any bean definition as the container loads.</p>
<p>In this model, you set up some special bean definitions in your XML bean definition file
to configure the auto proxy infrastructure. This allows you just to declare the targets
eligible for auto-proxying: you don&#8217;t need to use <code class="literal">ProxyFactoryBean</code>.</p>
<p>There are two ways to do this:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Using an auto-proxy creator that refers to specific beans in the current context.
</li><li class="listitem">
A special case of auto-proxy creation that deserves to be considered separately;
auto-proxy creation driven by source-level metadata attributes.
</li></ul></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-autoproxy-choices" href="#aop-autoproxy-choices"></a>10.9.1&nbsp;Autoproxy bean definitions</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.framework.autoproxy</code> package provides the following
standard auto-proxy creators.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy" href="#aop-api-autoproxy"></a>BeanNameAutoProxyCreator</h4></div></div></div>

<p>The <code class="literal">BeanNameAutoProxyCreator</code> class is a <code class="literal">BeanPostProcessor</code> that automatically creates
AOP proxies for beans with names matching literal values or wildcards.</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"beanNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"jdk*,onlyJdk"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;list&gt;</span>
            <span class="hl-tag">&lt;value&gt;</span>myInterceptor<span class="hl-tag">&lt;/value&gt;</span>
        <span class="hl-tag">&lt;/list&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>As with <code class="literal">ProxyFactoryBean</code>, there is an <code class="literal">interceptorNames</code> property rather than a list
of interceptors, to allow correct behavior for prototype advisors. Named "interceptors"
can be advisors or any advice type.</p>
<p>As with auto proxying in general, the main point of using <code class="literal">BeanNameAutoProxyCreator</code> is
to apply the same configuration consistently to multiple objects, with minimal volume of
configuration. It is a popular choice for applying declarative transactions to multiple
objects.</p>
<p>Bean definitions whose names match, such as "jdkMyBean" and "onlyJdk" in the above
example, are plain old bean definitions with the target class. An AOP proxy will be
created automatically by the <code class="literal">BeanNameAutoProxyCreator</code>. The same advice will be applied
to all matching beans. Note that if advisors are used (rather than the interceptor in
the above example), the pointcuts may apply differently to different beans.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy-default" href="#aop-api-autoproxy-default"></a>DefaultAdvisorAutoProxyCreator</h4></div></div></div>

<p>A more general and extremely powerful auto proxy creator is
<code class="literal">DefaultAdvisorAutoProxyCreator</code>. This will automagically apply eligible advisors in the
current context, without the need to include specific bean names in the auto-proxy
advisor&#8217;s bean definition. It offers the same merit of consistent configuration and
avoidance of duplication as <code class="literal">BeanNameAutoProxyCreator</code>.</p>
<p>Using this mechanism involves:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Specifying a <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition.
</li><li class="listitem">
Specifying any number of Advisors in the same or related contexts. Note that these
<span class="emphasis"><em>must</em></span> be Advisors, not just interceptors or other advices. This is necessary
because there must be a pointcut to evaluate, to check the eligibility of each advice
to candidate bean definitions.
</li></ul></div>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> will automatically evaluate the pointcut contained
in each advisor, to see what (if any) advice it should apply to each business object
(such as "businessObject1" and "businessObject2" in the example).</p>
<p>This means that any number of advisors can be applied automatically to each business
object. If no pointcut in any of the advisors matches any method in a business object,
the object will not be proxied. As bean definitions are added for new business objects,
they will automatically be proxied if necessary.</p>
<p>Autoproxying in general has the advantage of making it impossible for callers or
dependencies to obtain an un-advised object. Calling getBean("businessObject1") on this
ApplicationContext will return an AOP proxy, not the target business object. (The "inner
bean" idiom shown earlier also offers this benefit.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"customAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyAdvisor"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject1"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject1"</span><span class="hl-tag">&gt;</span>
    <span class="hl-comment">&lt;!-- Properties omitted --&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject2"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.BusinessObject2"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> is very useful if you want to apply the same advice
consistently to many business objects. Once the infrastructure definitions are in place,
you can simply add new business objects without including specific proxy configuration.
You can also drop in additional aspects very easily - for example, tracing or
performance monitoring aspects - with minimal change to configuration.</p>
<p>The DefaultAdvisorAutoProxyCreator offers support for filtering (using a naming
convention so that only certain advisors are evaluated, allowing use of multiple,
differently configured, AdvisorAutoProxyCreators in the same factory) and ordering.
Advisors can implement the <code class="literal">org.springframework.core.Ordered</code> interface to ensure
correct ordering if this is an issue. The TransactionAttributeSourceAdvisor used in the
above example has a configurable order value; the default setting is unordered.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="aop-api-autoproxy-abstract" href="#aop-api-autoproxy-abstract"></a>AbstractAdvisorAutoProxyCreator</h4></div></div></div>

<p>This is the superclass of DefaultAdvisorAutoProxyCreator. You can create your own
auto-proxy creators by subclassing this class, in the unlikely event that advisor
definitions offer insufficient customization to the behavior of the framework
<code class="literal">DefaultAdvisorAutoProxyCreator</code>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-autoproxy-metadata" href="#aop-autoproxy-metadata"></a>10.9.2&nbsp;Using metadata-driven auto-proxying</h3></div></div></div>

<p>A particularly important type of auto-proxying is driven by metadata. This produces a
similar programming model to .NET <code class="literal">ServicedComponents</code>. Instead of defining metadata in
XML descriptors, configuration for transaction management and other enterprise services
is held in source-level attributes.</p>
<p>In this case, you use the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, in combination with Advisors
that understand metadata attributes. The metadata specifics are held in the pointcut
part of the candidate advisors, rather than in the auto-proxy creation class itself.</p>
<p>This is really a special case of the <code class="literal">DefaultAdvisorAutoProxyCreator</code>, but deserves
consideration on its own. (The metadata-aware code is in the pointcuts contained in the
advisors, not the AOP framework itself.)</p>
<p>The <code class="literal">/attributes</code> directory of the JPetStore sample application shows the use of
attribute-driven auto-proxying. In this case, there&#8217;s no need to use the
<code class="literal">TransactionProxyFactoryBean</code>. Simply defining transactional attributes on business
objects is sufficient, because of the use of metadata-aware pointcuts. The bean
definitions include the following code, in <code class="literal">/WEB-INF/declarativeServices.xml</code>. Note that
this is generic, and can be used outside the JPetStore:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.AttributesTransactionAttributeSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"attributes"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/bean&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"attributes"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.metadata.commons.CommonsAttributes"</span><span class="hl-tag">/&gt;</span></pre>

<p>The <code class="literal">DefaultAdvisorAutoProxyCreator</code> bean definition (the name is not significant, hence
it can even be omitted) will pick up all eligible pointcuts in the current application
context. In this case, the "transactionAdvisor" bean definition, of type
<code class="literal">TransactionAttributeSourceAdvisor</code>, will apply to classes or methods carrying a
transaction attribute. The TransactionAttributeSourceAdvisor depends on a
TransactionInterceptor, via constructor dependency. The example resolves this via
autowiring. The <code class="literal">AttributesTransactionAttributeSource</code> depends on an implementation of
the <code class="literal">org.springframework.metadata.Attributes</code> interface. In this fragment, the
"attributes" bean satisfies this, using the Jakarta Commons Attributes API to obtain
attribute information. (The application code must have been compiled using the Commons
Attributes compilation task.)</p>
<p>The <code class="literal">/annotation</code> directory of the JPetStore sample application contains an analogous
example for auto-proxying driven by JDK 1.5+ annotations. The following configuration
enables automatic detection of Spring&#8217;s <code class="literal">Transactional</code> annotation, leading to implicit
proxies for beans containing that annotation:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionAttributeSourceAdvisor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionInterceptor"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionInterceptor"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionManager"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"transactionManager"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"transactionAttributeSource"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.annotation.AnnotationTransactionAttributeSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/property&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The <code class="literal">TransactionInterceptor</code> defined here depends on a <code class="literal">PlatformTransactionManager</code>
definition, which is not included in this generic file (although it could be) because it
will be specific to the application&#8217;s transaction requirements (typically JTA, as in
this example, or Hibernate, JDO or JDBC):</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transactionManager"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="hl-tag">/&gt;</span></pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>If you require only declarative transaction management, using these generic XML
definitions will result in Spring automatically proxying all classes or methods with
transaction attributes. You won&#8217;t need to work directly with AOP, and the programming
model is similar to that of .NET ServicedComponents.</p>
</td></tr></table></div>

<p>This mechanism is extensible. It&#8217;s possible to do auto-proxying based on custom
attributes. You need to:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Define your custom attribute.
</li><li class="listitem">
Specify an Advisor with the necessary advice, including a pointcut that is triggered
by the presence of the custom attribute on a class or method. You may be able to use
an existing advice, merely implementing a static pointcut that picks up the custom
attribute.
</li></ul></div>

<p>It&#8217;s possible for such advisors to be unique to each advised class (for example, mixins):
they simply need to be defined as prototype, rather than singleton, bean definitions.
For example, the <code class="literal">LockMixin</code> introduction interceptor from the Spring test suite,
shown above, could be used in conjunction with a generic <code class="literal">DefaultIntroductionAdvisor</code>:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockMixin"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"test.mixin.LockMixin"</span> <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"lockableAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.support.DefaultIntroductionAdvisor"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"lockMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that both <code class="literal">lockMixin</code> and <code class="literal">lockableAdvisor</code> are defined as prototypes.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-targetsource" href="#aop-targetsource"></a>10.10&nbsp;Using TargetSources</h2></div></div></div>

<p>Spring offers the concept of a <span class="emphasis"><em>TargetSource</em></span>, expressed in the
<code class="literal">org.springframework.aop.TargetSource</code> interface. This interface is responsible for
returning the "target object" implementing the join point. The <code class="literal">TargetSource</code>
implementation is asked for a target instance each time the AOP proxy handles a method
invocation.</p>
<p>Developers using Spring AOP don&#8217;t normally need to work directly with TargetSources, but
this provides a powerful means of supporting pooling, hot swappable and other
sophisticated targets. For example, a pooling TargetSource can return a different target
instance for each invocation, using a pool to manage instances.</p>
<p>If you do not specify a TargetSource, a default implementation is used that wraps a
local object. The same target is returned for each invocation (as you would expect).</p>
<p>Let&#8217;s look at the standard target sources provided with Spring, and how you can use them.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top">
<p>When using a custom target source, your target will usually need to be a prototype
rather than a singleton bean definition. This allows Spring to create a new target
instance when required.</p>
</td></tr></table></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-swap" href="#aop-ts-swap"></a>10.10.1&nbsp;Hot swappable target sources</h3></div></div></div>

<p>The <code class="literal">org.springframework.aop.target.HotSwappableTargetSource</code> exists to allow the target
of an AOP proxy to be switched while allowing callers to keep their references to it.</p>
<p>Changing the target source&#8217;s target takes effect immediately. The
<code class="literal">HotSwappableTargetSource</code> is threadsafe.</p>
<p>You can change the target via the <code class="literal">swap()</code> method on HotSwappableTargetSource as follows:</p>
<pre class="programlisting">HotSwappableTargetSource swapper = (HotSwappableTargetSource) beanFactory.getBean(<span class="hl-string">"swapper"</span>);
Object oldTarget = swapper.swap(newTarget);</pre>

<p>The XML definitions required look as follows:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"initialTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"mycompany.OldTarget"</span><span class="hl-tag">/&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swapper"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.HotSwappableTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"initialTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"swappable"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"swapper"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>The above <code class="literal">swap()</code> call changes the target of the swappable bean. Clients who hold a
reference to that bean will be unaware of the change, but will immediately start hitting
the new target.</p>
<p>Although this example doesn&#8217;t add any advice - and it&#8217;s not necessary to add advice to
use a <code class="literal">TargetSource</code> - of course any <code class="literal">TargetSource</code> can be used in conjunction with
arbitrary advice.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-pool" href="#aop-ts-pool"></a>10.10.2&nbsp;Pooling target sources</h3></div></div></div>

<p>Using a pooling target source provides a similar programming model to stateless session
EJBs, in which a pool of identical instances is maintained, with method invocations
going to free objects in the pool.</p>
<p>A crucial difference between Spring pooling and SLSB pooling is that Spring pooling can
be applied to any POJO. As with Spring in general, this service can be applied in a
non-invasive way.</p>
<p>Spring provides out-of-the-box support for Jakarta Commons Pool 1.3, which provides a
fairly efficient pooling implementation. You&#8217;ll need the commons-pool Jar on your
application&#8217;s classpath to use this feature. It&#8217;s also possible to subclass
<code class="literal">org.springframework.aop.target.AbstractPoolingTargetSource</code> to support any other
pooling API.</p>
<p>Sample configuration is shown below:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObjectTarget"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"com.mycompany.MyBusinessObject"</span>
        <span class="hl-attribute">scope</span>=<span class="hl-value">"prototype"</span><span class="hl-tag">&gt;</span>
    ... properties omitted
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.CommonsPoolTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"maxSize"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"25"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span>

<span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"businessObject"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.framework.ProxyFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetSource"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"interceptorNames"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"myInterceptor"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>Note that the target object - "businessObjectTarget" in the example - <span class="emphasis"><em>must</em></span> be a
prototype. This allows the <code class="literal">PoolingTargetSource</code> implementation to create new instances
of the target to grow the pool as necessary. See the javadocs of
<code class="literal">AbstractPoolingTargetSource</code> and the concrete subclass you wish to use for information
about its properties: "maxSize" is the most basic, and always guaranteed to be present.</p>
<p>In this case, "myInterceptor" is the name of an interceptor that would need to be
defined in the same IoC context. However, it isn&#8217;t necessary to specify interceptors to
use pooling. If you want only pooling, and no other advice, don&#8217;t set the
interceptorNames property at all.</p>
<p>It&#8217;s possible to configure Spring so as to be able to cast any pooled object to the
<code class="literal">org.springframework.aop.target.PoolingConfig</code> interface, which exposes information
about the configuration and current size of the pool through an introduction. You&#8217;ll
need to define an advisor like this:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"poolConfigAdvisor"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.beans.factory.config.MethodInvokingFactoryBean"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetObject"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"poolTargetSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetMethod"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"getPoolingConfigMixin"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>This advisor is obtained by calling a convenience method on the
<code class="literal">AbstractPoolingTargetSource</code> class, hence the use of MethodInvokingFactoryBean. This
advisor&#8217;s name ("poolConfigAdvisor" here) must be in the list of interceptors names in
the ProxyFactoryBean exposing the pooled object.</p>
<p>The cast will look as follows:</p>
<pre class="programlisting">PoolingConfig conf = (PoolingConfig) beanFactory.getBean(<span class="hl-string">"businessObject"</span>);
System.out.println(<span class="hl-string">"Max pool size is "</span> + conf.getMaxSize());</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>Pooling stateless service objects is not usually necessary. We don&#8217;t believe it should
be the default choice, as most stateless objects are naturally thread safe, and instance
pooling is problematic if resources are cached.</p>
</td></tr></table></div>

<p>Simpler pooling is available using auto-proxying. It&#8217;s possible to set the TargetSources
used by any auto-proxy creator.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-prototype" href="#aop-ts-prototype"></a>10.10.3&nbsp;Prototype target sources</h3></div></div></div>

<p>Setting up a "prototype" target source is similar to a pooling TargetSource. In this
case, a new instance of the target will be created on every method invocation. Although
the cost of creating a new object isn&#8217;t high in a modern JVM, the cost of wiring up the
new object (satisfying its IoC dependencies) may be more expensive. Thus you shouldn&#8217;t
use this approach without very good reason.</p>
<p>To do this, you could modify the <code class="literal">poolTargetSource</code> definition shown above as follows.
(I&#8217;ve also changed the name, for clarity.)</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"prototypeTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.PrototypeTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<p>There&#8217;s only one property: the name of the target bean. Inheritance is used in the
TargetSource implementations to ensure consistent naming. As with the pooling target
source, the target bean must be a prototype bean definition.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="aop-ts-threadlocal" href="#aop-ts-threadlocal"></a>10.10.4&nbsp;ThreadLocal target sources</h3></div></div></div>

<p><code class="literal">ThreadLocal</code> target sources are useful if you need an object to be created for each
incoming request (per thread that is). The concept of a <code class="literal">ThreadLocal</code> provide a JDK-wide
facility to transparently store resource alongside a thread. Setting up a
<code class="literal">ThreadLocalTargetSource</code> is pretty much the same as was explained for the other types
of target source:</p>
<pre class="programlisting"><span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"threadlocalTargetSource"</span> <span class="hl-attribute">class</span>=<span class="hl-value">"org.springframework.aop.target.ThreadLocalTargetSource"</span><span class="hl-tag">&gt;</span>
    <span class="hl-tag">&lt;property</span> <span class="hl-attribute">name</span>=<span class="hl-value">"targetBeanName"</span> <span class="hl-attribute">value</span>=<span class="hl-value">"businessObjectTarget"</span><span class="hl-tag">/&gt;</span>
<span class="hl-tag">&lt;/bean&gt;</span></pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>ThreadLocals come with serious issues (potentially resulting in memory leaks) when
incorrectly using them in a multi-threaded and multi-classloader environments. One
should always consider wrapping a threadlocal in some other class and never directly use
the <code class="literal">ThreadLocal</code> itself (except of course in the wrapper class). Also, one should
always remember to correctly set and unset (where the latter simply involved a call to
<code class="literal">ThreadLocal.set(null)</code>) the resource local to the thread. Unsetting should be done in
any case since not unsetting it might result in problematic behavior. Spring&#8217;s
ThreadLocal support does this for you and should always be considered in favor of using
ThreadLocals without other proper handling code.</p>
</td></tr></table></div>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-extensibility" href="#aop-extensibility"></a>10.11&nbsp;Defining new Advice types</h2></div></div></div>

<p>Spring AOP is designed to be extensible. While the interception implementation strategy
is presently used internally, it is possible to support arbitrary advice types in
addition to the out-of-the-box interception around advice, before, throws advice and
after returning advice.</p>
<p>The <code class="literal">org.springframework.aop.framework.adapter</code> package is an SPI package allowing
support for new custom advice types to be added without changing the core framework.
The only constraint on a custom <code class="literal">Advice</code> type is that it must implement the
<code class="literal">org.aopalliance.aop.Advice</code> marker interface.</p>
<p>Please refer to the <code class="literal">org.springframework.aop.framework.adapter</code> javadocs for further
information.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-api-resources" href="#aop-api-resources"></a>10.12&nbsp;Further resources</h2></div></div></div>

<p>Please refer to the Spring sample applications for further examples of Spring AOP:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The JPetStore&#8217;s default configuration illustrates the use of the
<code class="literal">TransactionProxyFactoryBean</code> for declarative transaction management.
</li><li class="listitem">
<p class="simpara">The <code class="literal">/attributes</code> directory of the JPetStore illustrates the use of attribute-driven
declarative transaction management.</p>
<p class="simpara"><a name="testing" href="#testing"></a>== Testing</p>
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="testing-introduction" href="#testing-introduction"></a>10.13&nbsp;Introduction to Spring Testing</h2></div></div></div>

<p>Testing is an integral part of enterprise software development. This chapter focuses on
the value-add of the IoC principle to <a class="link" href="http://itmyhome.com/spring/aop-api.html#unit-testing" title="10.14&nbsp;Unit Testing">unit testing</a> and on the benefits
of the Spring Framework&#8217;s support for <a class="link" href="http://itmyhome.com/spring/aop-api.html#integration-testing" title="10.15&nbsp;Integration Testing">integration testing</a>. <span class="emphasis"><em>(A
thorough treatment of testing in the enterprise is beyond the scope of this reference
manual.)</em></span></p>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="unit-testing" href="#unit-testing"></a>10.14&nbsp;Unit Testing</h2></div></div></div>

<p>Dependency Injection should make your code less dependent on the container than it would
be with traditional Java EE development. The POJOs that make up your application should
be testable in JUnit or TestNG tests, with objects simply instantiated using the <code class="literal">new</code>
operator, <span class="emphasis"><em>without Spring or any other container</em></span>. You can use <a class="link" href="http://itmyhome.com/spring/aop-api.html#mock-objects" title="10.14.1&nbsp;Mock Objects">mock
objects</a> (in conjunction with other valuable testing techniques) to test your code in
isolation. If you follow the architecture recommendations for Spring, the resulting
clean layering and componentization of your codebase will facilitate easier unit
testing. For example, you can test service layer objects by stubbing or mocking DAO or
Repository interfaces, without needing to access persistent data while running unit
tests.</p>
<p>True unit tests typically run extremely quickly, as there is no runtime infrastructure
to set up. Emphasizing true unit tests as part of your development methodology will
boost your productivity. You may not need this section of the testing chapter to help
you write effective unit tests for your IoC-based applications. For certain unit testing
scenarios, however, the Spring Framework provides the following mock objects and testing
support classes.</p>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mock-objects" href="#mock-objects"></a>10.14.1&nbsp;Mock Objects</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-env" href="#mock-objects-env"></a>Environment</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.env</code> package contains mock implementations of the
<code class="literal">Environment</code> and <code class="literal">PropertySource</code> abstractions (see <a class="xref" href="http://itmyhome.com/spring/beans.html#beans-definition-profiles" title="5.13.1&nbsp;Bean definition profiles">Section&nbsp;5.13.1, &#8220;Bean definition profiles&#8221;</a>
and <a class="xref" href="http://itmyhome.com/spring/beans.html#beans-property-source-abstraction" title="5.13.3&nbsp;PropertySource Abstraction">Section&nbsp;5.13.3, &#8220;PropertySource Abstraction&#8221;</a>). <code class="literal">MockEnvironment</code> and
<code class="literal">MockPropertySource</code> are useful for developing <span class="emphasis"><em>out-of-container</em></span> tests for code that
depends on environment-specific properties.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-jndi" href="#mock-objects-jndi"></a>JNDI</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.jndi</code> package contains an implementation of the JNDI SPI,
which you can use to set up a simple JNDI environment for test suites or stand-alone
applications. If, for example, JDBC <code class="literal">DataSource</code>s get bound to the same JNDI names in
test code as within a Java EE container, you can reuse both application code and
configuration in testing scenarios without modification.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-servlet" href="#mock-objects-servlet"></a>Servlet API</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.web</code> package contains a comprehensive set of Servlet API
mock objects, targeted at usage with Spring&#8217;s Web MVC framework, which are useful for
testing web contexts and controllers. These mock objects are generally more convenient
to use than dynamic mock objects such as <a class="ulink" href="http://www.easymock.org/" target="_top">EasyMock</a> or existing
Servlet API mock objects such as <a class="ulink" href="http://www.mockobjects.com/" target="_top">MockObjects</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mock-objects-portlet" href="#mock-objects-portlet"></a>Portlet API</h4></div></div></div>

<p>The <code class="literal">org.springframework.mock.web.portlet</code> package contains a set of Portlet API mock
objects, targeted at usage with Spring&#8217;s Portlet MVC framework.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="unit-testing-support-classes" href="#unit-testing-support-classes"></a>10.14.2&nbsp;Unit Testing support Classes</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="unit-testing-utilities" href="#unit-testing-utilities"></a>General utilities</h4></div></div></div>

<p>The <code class="literal">org.springframework.test.util</code> package contains <code class="literal">ReflectionTestUtils</code>, which is a
collection of reflection-based utility methods. Developers use these methods in unit and
integration testing scenarios in which they need to set a non- <code class="literal">public</code> field or invoke
a non- <code class="literal">public</code> setter method when testing application code involving, for example:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
ORM frameworks such as JPA and Hibernate that condone <code class="literal">private</code> or <code class="literal">protected</code> field
access as opposed to <code class="literal">public</code> setter methods for properties in a domain entity.
</li><li class="listitem">
Spring&#8217;s support for annotations such as <code class="literal">@Autowired</code>, <code class="literal">@Inject</code>, and <code class="literal">@Resource,</code>
which provides dependency injection for <code class="literal">private</code> or <code class="literal">protected</code> fields, setter
methods, and configuration methods.
</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="unit-testing-spring-mvc" href="#unit-testing-spring-mvc"></a>Spring MVC</h4></div></div></div>

<p>The <code class="literal">org.springframework.test.web</code> package contains <code class="literal">ModelAndViewAssert</code>, which you can
use in combination with JUnit, TestNG, or any other testing framework for unit tests
dealing with Spring MVC <code class="literal">ModelAndView</code> objects.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Unit testing Spring MVC Controllers"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Unit testing Spring MVC Controllers</th></tr><tr><td align="left" valign="top">

<p>To test your Spring MVC <code class="literal">Controller</code>s, use <code class="literal">ModelAndViewAssert</code> combined with
<code class="literal">MockHttpServletRequest</code>, <code class="literal">MockHttpSession</code>, and so on from the <a class="link" href="http://itmyhome.com/spring/aop-api.html#mock-objects-servlet" title="Servlet API"><code class="literal">org.springframework.mock.web</code></a> package.</p>
<p>Note: As of Spring 4.0, the set of mocks in the <code class="literal">org.springframework.mock.web</code> package
is now based on the Servlet 3.0 API.</p>
</td></tr></table></div>

</div>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="integration-testing" href="#integration-testing"></a>10.15&nbsp;Integration Testing</h2></div></div></div>

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-overview" href="#integration-testing-overview"></a>10.15.1&nbsp;Overview</h3></div></div></div>

<p>It is important to be able to perform some integration testing without requiring
deployment to your application server or connecting to other enterprise infrastructure.
This will enable you to test things such as:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The correct wiring of your Spring IoC container contexts.
</li><li class="listitem">
Data access using JDBC or an ORM tool. This would include such things as the
correctness of SQL statements, Hibernate queries, JPA entity mappings, etc.
</li></ul></div>

<p>The Spring Framework provides first-class support for integration testing in the
<code class="literal">spring-test</code> module. The name of the actual JAR file might include the release version
and might also be in the long <code class="literal">org.springframework.test</code> form, depending on where you
get it from (see the <a class="link" href="http://itmyhome.com/spring/overview.html#dependency-management" title="2.3.1&nbsp;Dependency Management and Naming Conventions">section on Dependency Management</a> for an
explanation). This library includes the <code class="literal">org.springframework.test</code> package, which
contains valuable classes for integration testing with a Spring container. This testing
does not rely on an application server or other deployment environment. Such tests are
slower to run than unit tests but much faster than the equivalent Selenium tests or remote
tests that rely on deployment to an application server.</p>
<p>In Spring 2.5 and later, unit and integration testing support is provided in the form of
the annotation-driven <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-framework" title="10.15.5&nbsp;Spring TestContext Framework">Spring TestContext Framework</a>. The
TestContext framework is agnostic of the actual testing framework in use, thus allowing
instrumentation of tests in various environments including JUnit, TestNG, and so on.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-goals" href="#integration-testing-goals"></a>10.15.2&nbsp;Goals of Integration Testing</h3></div></div></div>

<p>Spring&#8217;s integration testing support has the following primary goals:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
To manage <a class="link" href="http://itmyhome.com/spring/aop-api.html#testing-ctx-management" title="Context management and caching">Spring IoC container caching</a> between test
execution.
</li><li class="listitem">
To provide <a class="link" href="http://itmyhome.com/spring/aop-api.html#testing-fixture-di" title="Dependency Injection of test fixtures">Dependency Injection of test fixture instances</a>.
</li><li class="listitem">
To provide <a class="link" href="http://itmyhome.com/spring/aop-api.html#testing-tx" title="Transaction management">transaction management</a> appropriate to integration testing.
</li><li class="listitem">
To supply <a class="link" href="http://itmyhome.com/spring/aop-api.html#testing-support-classes" title="Support classes for integration testing">Spring-specific base classes</a> that assist
developers in writing integration tests.
</li></ul></div>

<p>The next few sections describe each goal and provide links to implementation and
configuration details.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-ctx-management" href="#testing-ctx-management"></a>Context management and caching</h4></div></div></div>

<p>The Spring TestContext Framework provides consistent loading of Spring
<code class="literal">ApplicationContext</code>s and <code class="literal">WebApplicationContext</code>s as well as caching of those
contexts. Support for the caching of loaded contexts is important, because startup time
can become an issue&#8201;&#8212;&#8201;not because of the overhead of Spring itself, but because the
objects instantiated by the Spring container take time to instantiate. For example, a
project with 50 to 100 Hibernate mapping files might take 10 to 20 seconds to load the
mapping files, and incurring that cost before running every test in every test fixture
leads to slower overall test runs that reduce developer productivity.</p>
<p>Test classes typically declare either an array of <span class="emphasis"><em>resource locations</em></span> for XML
configuration metadata&#8201;&#8212;&#8201;often in the classpath&#8201;&#8212;&#8201;or an array of <span class="emphasis"><em>annotated classes</em></span>
that is used to configure the application. These locations or classes are the same as or
similar to those specified in <code class="literal">web.xml</code> or other deployment configuration files.</p>
<p>By default, once loaded, the configured <code class="literal">ApplicationContext</code> is reused for each test.
Thus the setup cost is incurred only once per test suite, and subsequent test execution
is much faster. In this context, the term <span class="emphasis"><em>test suite</em></span> means all tests run in the same
JVM&#8201;&#8212;&#8201;for example, all tests run from an Ant, Maven, or Gradle build for a given
project or module. In the unlikely case that a test corrupts the application context and
requires reloading&#8201;&#8212;&#8201;for example, by modifying a bean definition or the state of an
application object&#8201;&#8212;&#8201;the TestContext framework can be configured to reload the
configuration and rebuild the application context before executing the next test.</p>
<p>See <a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management" title="Context management">the section called &#8220;Context management&#8221;</a> and <a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management-caching" title="Context caching">the section called &#8220;Context caching&#8221;</a> with the
TestContext framework.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-fixture-di" href="#testing-fixture-di"></a>Dependency Injection of test fixtures</h4></div></div></div>

<p>When the TestContext framework loads your application context, it can optionally
configure instances of your test classes via Dependency Injection. This provides a
convenient mechanism for setting up test fixtures using preconfigured beans from your
application context. A strong benefit here is that you can reuse application contexts
across various testing scenarios (e.g., for configuring Spring-managed object graphs,
transactional proxies, <code class="literal">DataSource</code>s, etc.), thus avoiding the need to duplicate
complex test fixture setup for individual test cases.</p>
<p>As an example, consider the scenario where we have a class, <code class="literal">HibernateTitleRepository</code>,
that implements data access logic for a <code class="literal">Title</code> domain entity. We want to write
integration tests that test the following areas:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The Spring configuration: basically, is everything related to the configuration of the
<code class="literal">HibernateTitleRepository</code> bean correct and present?
</li><li class="listitem">
The Hibernate mapping file configuration: is everything mapped correctly, and are the
correct lazy-loading settings in place?
</li><li class="listitem">
The logic of the <code class="literal">HibernateTitleRepository</code>: does the configured instance of this
class perform as anticipated?
</li></ul></div>

<p>See dependency injection of test fixtures with the <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-fixture-di" title="Dependency injection of test fixtures">TestContext
framework</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-tx" href="#testing-tx"></a>Transaction management</h4></div></div></div>

<p>One common issue in tests that access a real database is their effect on the state of
the persistence store. Even when you&#8217;re using a development database, changes to the
state may affect future tests. Also, many operations&#8201;&#8212;&#8201;such as inserting or modifying
persistent data&#8201;&#8212;&#8201;cannot be performed (or verified) outside a transaction.</p>
<p>The TestContext framework addresses this issue. By default, the framework will create
and roll back a transaction for each test. You simply write code that can assume the
existence of a transaction. If you call transactionally proxied objects in your tests,
they will behave correctly, according to their configured transactional semantics. In
addition, if a test method deletes the contents of selected tables while running within
the transaction managed for the test, the transaction will roll back by default, and the
database will return to its state prior to execution of the test. Transactional support
is provided to a test via a <code class="literal">PlatformTransactionManager</code> bean defined in the test&#8217;s
application context.</p>
<p>If you want a transaction to commit&#8201;&#8212;&#8201;unusual, but occasionally useful when you want a
particular test to populate or modify the database&#8201;&#8212;&#8201;the TestContext framework can be
instructed to cause the transaction to commit instead of roll back via the
<a class="link" href="http://itmyhome.com/spring/aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;Annotations"><code class="literal">@TransactionConfiguration</code></a> and
<a class="link" href="http://itmyhome.com/spring/aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;Annotations"><code class="literal">@Rollback</code></a> annotations.</p>
<p>See transaction management with the <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-tx" title="Transaction management">TestContext framework</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testing-support-classes" href="#testing-support-classes"></a>Support classes for integration testing</h4></div></div></div>

<p>The Spring TestContext Framework provides several <code class="literal">abstract</code> support classes that
simplify the writing of integration tests. These base test classes provide well-defined
hooks into the testing framework as well as convenient instance variables and methods,
which enable you to access:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
The <code class="literal">ApplicationContext</code>, for performing explicit bean lookups or testing the state of
the context as a whole.
</li><li class="listitem">
A <code class="literal">JdbcTemplate</code>, for executing SQL statements to query the database. Such queries can
be used to confirm database state both <span class="emphasis"><em>prior to</em></span> and <span class="emphasis"><em>after</em></span> execution of
database-related application code, and Spring ensures that such queries run in the
scope of the same transaction as the application code. When used in conjunction with
an ORM tool, be sure to avoid <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-tx-false-positives" title="Avoid false positives when testing ORM code">false positives</a>.
</li></ul></div>

<p>In addition, you may want to create your own custom, application-wide superclass with
instance variables and methods specific to your project.</p>
<p>See support classes for the <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-support-classes" title="TestContext Framework support classes">TestContext framework</a>.</p>
</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-support-jdbc" href="#integration-testing-support-jdbc"></a>10.15.3&nbsp;JDBC Testing Support</h3></div></div></div>

<p>The <code class="literal">org.springframework.test.jdbc</code> package contains <code class="literal">JdbcTestUtils</code>, which is a
collection of JDBC related utility functions intended to simplify standard database
testing scenarios. Specifically, <code class="literal">JdbcTestUtils</code> provides the following static utility
methods.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">countRowsInTable(..)</code>: counts the number of rows in the given table
</li><li class="listitem">
<code class="literal">countRowsInTableWhere(..)</code>: counts the number of rows in the given table, using
the provided <code class="literal">WHERE</code> clause
</li><li class="listitem">
<code class="literal">deleteFromTables(..)</code>: deletes all rows from the specified tables
</li><li class="listitem">
<code class="literal">deleteFromTableWhere(..)</code>: deletes rows from the given table, using the provided
<code class="literal">WHERE</code> clause
</li><li class="listitem">
<code class="literal">dropTables(..)</code>: drops the specified tables
</li></ul></div>

<p><span class="emphasis"><em>Note that <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-support-classes-junit4" title="JUnit support classes"><code class="literal">AbstractTransactionalJUnit4SpringContextTests</code></a> and
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-support-classes-testng" title="TestNG support classes"><code class="literal">AbstractTransactionalTestNGSpringContextTests</code></a>
provide convenience methods which delegate to the aforementioned methods in
<code class="literal">JdbcTestUtils</code>.</em></span></p>
<p>The <code class="literal">spring-jdbc</code> module provides support for configuring and launching an embedded
database which can be used in integration tests that interact with a database. For
details, see <a class="xref" href="http://itmyhome.com/spring/jdbc.html#jdbc-embedded-database-support" title="13.8&nbsp;Embedded database support">Section&nbsp;13.8, &#8220;Embedded database support&#8221;</a> and
<a class="xref" href="http://itmyhome.com/spring/jdbc.html#jdbc-embedded-database-dao-testing" title="13.8.8&nbsp;Testing data access logic with an embedded database">Section&nbsp;13.8.8, &#8220;Testing data access logic with an embedded database&#8221;</a>.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="integration-testing-annotations" href="#integration-testing-annotations"></a>10.15.4&nbsp;Annotations</h3></div></div></div>

<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-spring" href="#integration-testing-annotations-spring"></a>Spring Testing Annotations</h4></div></div></div>

<p>The Spring Framework provides the following set of <span class="emphasis"><em>Spring-specific</em></span> annotations that
you can use in your unit and integration tests in conjunction with the TestContext
framework. Refer to the corresponding javadocs for further information, including
default attribute values, attribute aliases, and so on.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><code class="literal">@ContextConfiguration</code></p>
<p class="simpara">Defines class-level metadata that is used to determine how to load and configure an
<code class="literal">ApplicationContext</code> for integration tests. Specifically, <code class="literal">@ContextConfiguration</code>
declares the application context resource <code class="literal">locations</code> or the annotated <code class="literal">classes</code>
that will be used to load the context.</p>
<p class="simpara">Resource locations are typically XML configuration files located in the classpath;
whereas, annotated classes are typically <code class="literal">@Configuration</code> classes. However, resource
locations can also refer to files in the file system, and annotated classes can be
component classes, etc.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="hl-string">"/test-config.xml"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> XmlApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>classes</strong></span> = TestConfig.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ConfigClassApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">As an alternative or in addition to declaring resource locations or annotated classes,
<code class="literal">@ContextConfiguration</code> may be used to declare <code class="literal">ApplicationContextInitializer</code> classes.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>initializers</strong></span> = CustomContextIntializer.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextInitializerTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara"><code class="literal">@ContextConfiguration</code> may optionally be used to declare the <code class="literal">ContextLoader</code> strategy
as well. Note, however, that you typically do not need to explicitly configure the
loader since the default loader supports either resource <code class="literal">locations</code> or annotated
<code class="literal">classes</code> as well as <code class="literal">initializers</code>.</p>
<pre class="programlisting"><span class="strong"><strong>@ContextConfiguration</strong></span>(<span class="strong"><strong>locations</strong></span> = <span class="hl-string">"/test-context.xml"</span>, <span class="strong"><strong>loader</strong></span> = CustomContextLoader.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomLoaderXmlApplicationContextTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ContextConfiguration</code> provides support for <span class="emphasis"><em>inheriting</em></span> resource locations or
configuration classes as well as context initializers declared by superclasses by
default.</p>
</td></tr></table></div>

<p class="simpara">See <a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management" title="Context management">the section called &#8220;Context management&#8221;</a> and the <code class="literal">@ContextConfiguration</code> javadocs for
further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@WebAppConfiguration</code></p>
<p class="simpara">A class-level annotation that is used to declare that the <code class="literal">ApplicationContext</code> loaded
for an integration test should be a <code class="literal">WebApplicationContext</code>. The mere presence of
<code class="literal">@WebAppConfiguration</code> on a test class ensures that a <code class="literal">WebApplicationContext</code> will be
loaded for the test, using the default value of <code class="literal">"file:src/main/webapp"</code> for the path to
the root of the web application (i.e., the <span class="emphasis"><em>resource base path</em></span>). The resource base
path is used behind the scenes to create a <code class="literal">MockServletContext</code> which serves as the
<code class="literal">ServletContext</code> for the test&#8217;s <code class="literal">WebApplicationContext</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@WebAppConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebAppTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">To override the default, specify a different base resource path via the <span class="emphasis"><em>implicit</em></span>
<code class="literal">value</code> attribute. Both <code class="literal">classpath:</code> and <code class="literal">file:</code> resource prefixes are supported. If no
resource prefix is supplied the path is assumed to be a file system resource.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@WebAppConfiguration("classpath:test-web-resources")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebAppTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">Note that <code class="literal">@WebAppConfiguration</code> must be used in conjunction with
<code class="literal">@ContextConfiguration</code>, either within a single test class or within a test class
hierarchy. See the <code class="literal">@WebAppConfiguration</code> javadocs for further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@ContextHierarchy</code></p>
<p class="simpara">A class-level annotation that is used to define a hierarchy of <code class="literal">ApplicationContext</code>s
for integration tests. <code class="literal">@ContextHierarchy</code> should be declared with a list of one or more
<code class="literal">@ContextConfiguration</code> instances, each of which defines a level in the context
hierarchy. The following examples demonstrate the use of <code class="literal">@ContextHierarchy</code> within a
single test class; however, <code class="literal">@ContextHierarchy</code> can also be used within a test class
hierarchy.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration("/parent-config.xml"),
    @ContextConfiguration("/child-config.xml")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextHierarchyTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration(classes = AppConfig.class),
    @ContextConfiguration(classes = WebConfig.class)
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WebIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">If you need to merge or override the configuration for a given level of the context
hierarchy within a test class hierarchy, you must explicitly name that level by
supplying the same value to the <code class="literal">name</code> attribute in <code class="literal">@ContextConfiguration</code> at each
corresponding level in the class hierarchy. See
<a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management-ctx-hierarchies" title="Context hierarchies">the section called &#8220;Context hierarchies&#8221;</a> and the <code class="literal">@ContextHierarchy</code> javadocs
for further examples.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@ActiveProfiles</code></p>
<p class="simpara">A class-level annotation that is used to declare which <span class="emphasis"><em>bean definition profiles</em></span>
should be active when loading an <code class="literal">ApplicationContext</code> for test classes.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@ActiveProfiles</strong></span>(<span class="hl-string">"dev"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DeveloperTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@ActiveProfiles</strong></span>({<span class="hl-string">"dev"</span>, <span class="hl-string">"integration"</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DeveloperIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ActiveProfiles</code> provides support for <span class="emphasis"><em>inheriting</em></span> active bean definition profiles
declared by superclasses by default. It is also possible to resolve active bean
definition profiles programmatically by implementing a custom
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management-env-profiles-ActiveProfilesResolver"><code class="literal">ActiveProfilesResolver</code></a>
and registering it via the <code class="literal">resolver</code> attribute of <code class="literal">@ActiveProfiles</code>.</p>
</td></tr></table></div>

<p class="simpara">See <a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management-env-profiles" title="Context configuration with environment profiles">the section called &#8220;Context configuration with environment profiles&#8221;</a> and the <code class="literal">@ActiveProfiles</code> javadocs
for examples and further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TestPropertySource</code></p>
<p class="simpara">A class-level annotation that is used to configure the locations of properties files and
inlined properties to be added to the <code class="literal">Environment</code>'s set of <code class="literal">PropertySources</code> for an
<code class="literal">ApplicationContext</code> loaded for an integration test.</p>
<p class="simpara">Test property sources have higher precedence than those loaded from the operating
system&#8217;s environment or Java system properties as well as property sources added by the
application declaratively via <code class="literal">@PropertySource</code> or programmatically. Thus, test property
sources can be used to selectively override properties defined in system and application
property sources. Furthermore, inlined properties have higher precedence than properties
loaded from resource locations.</p>
<p class="simpara">The following example demonstrates how to declare a properties file from the classpath.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TestPropertySource</strong></span>(<span class="hl-string">"/test.properties"</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara">The following example demonstrates how to declare <span class="emphasis"><em>inlined</em></span> properties.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TestPropertySource</strong></span>(properties = { <span class="hl-string">"timezone = GMT"</span>, <span class="hl-string">"port: 4242"</span> })
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@DirtiesContext</code></p>
<p class="simpara">Indicates that the underlying Spring <code class="literal">ApplicationContext</code> has been <span class="emphasis"><em>dirtied</em></span> during
the execution of a test (i.e., modified or corrupted in some manner&#8201;&#8212;&#8201;for example, by
changing the state of a singleton bean) and should be closed, regardless of whether the
test passed. When an application context is marked <span class="emphasis"><em>dirty</em></span>, it is removed from the
testing framework&#8217;s cache and closed. As a consequence, the underlying Spring container
will be rebuilt for any subsequent test that requires a context with the same
configuration metadata.</p>
<p class="simpara"><code class="literal">@DirtiesContext</code> can be used as both a class-level and method-level annotation within
the same test class. In such scenarios, the <code class="literal">ApplicationContext</code> is marked as <span class="emphasis"><em>dirty</em></span>
after any such annotated method as well as after the entire class. If the <code class="literal">ClassMode</code> is
set to <code class="literal">AFTER_EACH_TEST_METHOD</code>, the context is marked dirty after each test method in
the class.</p>
<p class="simpara">The following examples explain when the context would be dirtied for various
configuration scenarios:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<p class="simpara">After the current test class, when declared on a class with class mode set to
<code class="literal">AFTER_CLASS</code> (i.e., the default class mode).</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextDirtyingTests {
    <span class="hl-comment">// some tests that result in the Spring container being dirtied</span>
}</pre>

</li><li class="listitem">
<p class="simpara">After each test method in the current test class, when declared on a class with class
mode set to <code class="literal">AFTER_EACH_TEST_METHOD.</code></p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>(<span class="strong"><strong>classMode</strong></span> = ClassMode.AFTER_EACH_TEST_METHOD)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ContextDirtyingTests {
    <span class="hl-comment">// some tests that result in the Spring container being dirtied</span>
}</pre>

</li><li class="listitem">
<p class="simpara">After the current test, when declared on a method.</p>
<pre class="programlisting"><span class="strong"><strong>@DirtiesContext</strong></span>
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichDirtiesAppCtx() {
    <span class="hl-comment">// some logic that results in the Spring container being dirtied</span>
}</pre>

<p class="simpara">If <code class="literal">@DirtiesContext</code> is used in a test whose context is configured as part of a context
hierarchy via <code class="literal">@ContextHierarchy</code>, the <code class="literal">hierarchyMode</code> flag can be used to control how
the context cache is cleared. By default an <span class="emphasis"><em>exhaustive</em></span> algorithm will be used that
clears the context cache including not only the current level but also all other context
hierarchies that share an ancestor context common to the current test; all
<code class="literal">ApplicationContext</code>s that reside in a sub-hierarchy of the common ancestor context
will be removed from the context cache and closed. If the <span class="emphasis"><em>exhaustive</em></span> algorithm is
overkill for a particular use case, the simpler <span class="emphasis"><em>current level</em></span> algorithm can be
specified instead, as seen below.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextHierarchy({
    @ContextConfiguration("/parent-config.xml"),
    @ContextConfiguration("/child-config.xml")
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTests {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTests <span class="hl-keyword">extends</span> BaseTests {

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    @DirtiesContext(<span class="strong"><strong>hierarchyMode = HierarchyMode.CURRENT_LEVEL</strong></span>)
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> test() {
        <span class="hl-comment">// some logic that results in the child context being dirtied</span>
    }
}</pre>

</li></ul></div>

<p class="simpara">For further details regarding the <code class="literal">EXHAUSTIVE</code> and <code class="literal">CURRENT_LEVEL</code> algorithms see the
<code class="literal">DirtiesContext.HierarchyMode</code> javadocs.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TestExecutionListeners</code></p>
<p class="simpara">Defines class-level metadata for configuring which <code class="literal">TestExecutionListener</code>s should be
registered with the <code class="literal">TestContextManager</code>. Typically, <code class="literal">@TestExecutionListeners</code> is used
in conjunction with <code class="literal">@ContextConfiguration</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TestExecutionListeners</strong></span>({CustomTestExecutionListener.<span class="hl-keyword">class</span>, AnotherTestExecutionListener.<span class="hl-keyword">class</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomTestExecutionListenerTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p class="simpara"><code class="literal">@TestExecutionListeners</code> supports <span class="emphasis"><em>inherited</em></span> listeners by default. See the javadocs
for an example and further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@TransactionConfiguration</code></p>
<p class="simpara">Defines class-level metadata for configuring transactional tests. Specifically, the bean
name of the <code class="literal">PlatformTransactionManager</code> that should be used to drive transactions can
be explicitly specified if there are multiple beans of type <code class="literal">PlatformTransactionManager</code>
in the test&#8217;s <code class="literal">ApplicationContext</code> and if the bean name of the desired
<code class="literal">PlatformTransactionManager</code> is not "transactionManager". In addition, you can change
the <code class="literal">defaultRollback</code> flag to <code class="literal">false</code>. Typically, <code class="literal">@TransactionConfiguration</code> is used in
conjunction with <code class="literal">@ContextConfiguration</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="strong"><strong>@TransactionConfiguration</strong></span>(<span class="strong"><strong>transactionManager</strong></span> = <span class="hl-string">"txMgr"</span>, <span class="strong"><strong>defaultRollback</strong></span> = false)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomConfiguredTransactionalTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p>If the default conventions are sufficient for your test configuration, you can avoid
using <code class="literal">@TransactionConfiguration</code> altogether. In other words, if you have only one
transaction manager&#8201;&#8212;&#8201;or if you have multiple transaction managers but the transaction
manager for tests is named "transactionManager" or specified via a
<code class="literal">TransactionManagementConfigurer</code>&#8201;&#8212;&#8201;and if you want transactions to roll back
automatically, then there is no need to annotate your test class with
<code class="literal">@TransactionConfiguration</code>.</p>
</td></tr></table></div>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Rollback</code></p>
<p class="simpara">Indicates whether the transaction for the annotated test method should be <span class="emphasis"><em>rolled
back</em></span> after the test method has completed. If <code class="literal">true</code>, the transaction is rolled back;
otherwise, the transaction is committed. Use <code class="literal">@Rollback</code> to override the default
rollback flag configured at the class level.</p>
<pre class="programlisting"><span class="strong"><strong>@Rollback</strong></span>(false)
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWithoutRollback() {
    <span class="hl-comment">// ...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@BeforeTransaction</code></p>
<p class="simpara">Indicates that the annotated <code class="literal">public void</code> method should be executed <span class="emphasis"><em>before</em></span> a
transaction is started for test methods configured to run within a transaction via the
<code class="literal">@Transactional</code> annotation.</p>
<pre class="programlisting"><span class="strong"><strong>@BeforeTransaction</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> beforeTransaction() {
    <span class="hl-comment">// logic to be executed before a transaction is started</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@AfterTransaction</code></p>
<p class="simpara">Indicates that the annotated <code class="literal">public void</code> method should be executed <span class="emphasis"><em>after</em></span> a
transaction has ended for test methods configured to run within a transaction via the
<code class="literal">@Transactional</code> annotation.</p>
<pre class="programlisting"><span class="strong"><strong>@AfterTransaction</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> afterTransaction() {
    <span class="hl-comment">// logic to be executed after a transaction has ended</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Sql</code></p>
<p class="simpara">Used to annotate a test class or test method to configure SQL scripts to be executed
against a given database during integration tests.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="strong"><strong>@Sql</strong></span>({<span class="hl-string">"/test-schema.sql"</span>, <span class="hl-string">"/test-user-data.sql"</span>})
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// execute code that relies on the test schema and test data</span>
}</pre>

<p class="simpara">See <a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-executing-sql-declaratively" title="Executing SQL scripts declaratively with @Sql">the section called &#8220;Executing SQL scripts declaratively with <code class="literal">@Sql</code>&#8221;</a> for further details.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@SqlConfig</code></p>
<p class="simpara">Defines metadata that is used to determine how to parse and execute SQL scripts
configured via the <code class="literal">@Sql</code> annotation.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
@Sql(
    scripts = <span class="hl-string">"/test-user-data.sql"</span>,
    config = <span class="strong"><strong>@SqlConfig</strong></span>(commentPrefix = <span class="hl-string">"`"</span>, separator = <span class="hl-string">"@@"</span>)
)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// execute code that relies on the test data</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@SqlGroup</code></p>
<p class="simpara">A container annotation that aggregates several <code class="literal">@Sql</code> annotations. Can be used natively,
declaring several nested <code class="literal">@Sql</code> annotations. Can also be used in conjunction with Java
8&#8217;s support for repeatable annotations, where <code class="literal">@Sql</code> can simply be declared several times
on the same class or method, implicitly generating this container annotation.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="strong"><strong>@SqlGroup</strong></span>({
    <em><span class="hl-annotation" style="color: gray">@Sql(scripts = "/test-schema.sql", config = @SqlConfig(commentPrefix = "`")),</span></em>
    <em><span class="hl-annotation" style="color: gray">@Sql("/test-user-data.sql")</span></em>
)}
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> userTest {
    <span class="hl-comment">// execute code that uses the test schema and test data</span>
}</pre>

</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-standard" href="#integration-testing-annotations-standard"></a>Standard Annotation Support</h4></div></div></div>

<p>The following annotations are supported with standard semantics for all configurations
of the Spring TestContext Framework. Note that these annotations are not specific to
tests and can be used anywhere in the Spring Framework.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@Autowired</code>
</li><li class="listitem">
<code class="literal">@Qualifier</code>
</li><li class="listitem">
<code class="literal">@Resource</code> (javax.annotation) <span class="emphasis"><em>if JSR-250 is present</em></span>
</li><li class="listitem">
<code class="literal">@Inject</code> (javax.inject) <span class="emphasis"><em>if JSR-330 is present</em></span>
</li><li class="listitem">
<code class="literal">@Named</code> (javax.inject) <span class="emphasis"><em>if JSR-330 is present</em></span>
</li><li class="listitem">
<code class="literal">@PersistenceContext</code> (javax.persistence) <span class="emphasis"><em>if JPA is present</em></span>
</li><li class="listitem">
<code class="literal">@PersistenceUnit</code> (javax.persistence) <span class="emphasis"><em>if JPA is present</em></span>
</li><li class="listitem">
<code class="literal">@Required</code>
</li><li class="listitem">
<code class="literal">@Transactional</code>
</li></ul></div>

<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: JSR-250 Lifecycle Annotations"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">JSR-250 Lifecycle Annotations</th></tr><tr><td align="left" valign="top">

<p>In the Spring TestContext Framework <code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code> may be used with
standard semantics on any application components configured in the <code class="literal">ApplicationContext</code>;
however, these lifecycle annotations have limited usage within an actual test class.</p>
<p>If a method within a test class is annotated with <code class="literal">@PostConstruct</code>, that method will be
executed before any <span class="emphasis"><em>before</em></span> methods of the underlying test framework (e.g., methods
annotated with JUnit&#8217;s <code class="literal">@Before</code>), and that will apply for every test method in the test
class. On the other hand, if a method within a test class is annotated with
<code class="literal">@PreDestroy</code>, that method will <span class="emphasis"><em>never</em></span> be executed. Within a test class it is
therefore recommended to use test lifecycle callbacks from the underlying test framework
instead of <code class="literal">@PostConstruct</code> and <code class="literal">@PreDestroy</code>.</p>
</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-junit" href="#integration-testing-annotations-junit"></a>Spring JUnit Testing Annotations</h4></div></div></div>

<p>The following annotations are <span class="emphasis"><em>only</em></span> supported when used in conjunction with the
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-junit4-runner" title="Spring JUnit Runner">SpringJUnit4ClassRunner</a> or the
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-support-classes-junit4" title="JUnit support classes">JUnit</a> support classes.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<p class="simpara"><code class="literal">@IfProfileValue</code></p>
<p class="simpara">Indicates that the annotated test is enabled for a specific testing environment. If the
configured <code class="literal">ProfileValueSource</code> returns a matching <code class="literal">value</code> for the provided <code class="literal">name</code>, the
test is enabled. This annotation can be applied to an entire class or to individual
methods. Class-level usage overrides method-level usage.</p>
<pre class="programlisting"><span class="strong"><strong>@IfProfileValue</strong></span>(<span class="strong"><strong>name</strong></span>=<span class="hl-string">"java.vendor"</span>, <span class="strong"><strong>value</strong></span>=<span class="hl-string">"Oracle Corporation"</span>)
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichRunsOnlyOnOracleJvm() {
    <span class="hl-comment">// some logic that should run only on Java VMs from Oracle Corporation</span>
}</pre>

<p class="simpara">Alternatively, you can configure <code class="literal">@IfProfileValue</code> with a list of <code class="literal">values</code> (with <span class="emphasis"><em>OR</em></span>
semantics) to achieve TestNG-like support for <span class="emphasis"><em>test groups</em></span> in a JUnit environment.
Consider the following example:</p>
<pre class="programlisting"><span class="strong"><strong>@IfProfileValue</strong></span>(<span class="strong"><strong>name</strong></span>=<span class="hl-string">"test-groups"</span>, <span class="strong"><strong>values</strong></span>={<span class="hl-string">"unit-tests"</span>, <span class="hl-string">"integration-tests"</span>})
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWhichRunsForUnitOrIntegrationTestGroups() {
    <span class="hl-comment">// some logic that should run only for unit and integration test groups</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@ProfileValueSourceConfiguration</code></p>
<p class="simpara">Class-level annotation that specifies what type of <code class="literal">ProfileValueSource</code> to use when
retrieving <span class="emphasis"><em>profile values</em></span> configured through the <code class="literal">@IfProfileValue</code> annotation. If
<code class="literal">@ProfileValueSourceConfiguration</code> is not declared for a test,
<code class="literal">SystemProfileValueSource</code> is used by default.</p>
<pre class="programlisting"><span class="strong"><strong>@ProfileValueSourceConfiguration</strong></span>(CustomProfileValueSource.<span class="hl-keyword">class</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> CustomProfileValueSourceTests {
    <span class="hl-comment">// class body...</span>
}</pre>

</li><li class="listitem">
<p class="simpara"><code class="literal">@Timed</code></p>
<p class="simpara">Indicates that the annotated test method must finish execution in a specified time
period (in milliseconds). If the text execution time exceeds the specified time period,
the test fails.</p>
<p class="simpara">The time period includes execution of the test method itself, any repetitions of the
test (see <code class="literal">@Repeat</code>), as well as any <span class="emphasis"><em>set up</em></span> or <span class="emphasis"><em>tear down</em></span> of the test fixture.</p>
<pre class="programlisting"><span class="strong"><strong>@Timed</strong></span>(millis=<span class="hl-number">1000</span>)
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessWithOneSecondTimeout() {
    <span class="hl-comment">// some logic that should not take longer than 1 second to execute</span>
}</pre>

<p class="simpara">Spring&#8217;s <code class="literal">@Timed</code> annotation has different semantics than JUnit&#8217;s <code class="literal">@Test(timeout=...)</code>
support. Specifically, due to the manner in which JUnit handles test execution timeouts
(that is, by executing the test method in a separate <code class="literal">Thread</code>), <code class="literal">@Test(timeout=...)</code>
preemptively fails the test if the test takes too long. Spring&#8217;s <code class="literal">@Timed</code>, on the other
hand, does not preemptively fail the test but rather waits for the test to complete
before failing.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">@Repeat</code></p>
<p class="simpara">Indicates that the annotated test method must be executed repeatedly. The number of
times that the test method is to be executed is specified in the annotation.</p>
<p class="simpara">The scope of execution to be repeated includes execution of the test method itself as
well as any <span class="emphasis"><em>set up</em></span> or <span class="emphasis"><em>tear down</em></span> of the test fixture.</p>
<pre class="programlisting"><span class="strong"><strong>@Repeat</strong></span>(<span class="hl-number">10</span>)
<em><span class="hl-annotation" style="color: gray">@Test</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testProcessRepeatedly() {
    <span class="hl-comment">// ...</span>
}</pre>

</li></ul></div>

</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="integration-testing-annotations-meta" href="#integration-testing-annotations-meta"></a>Meta-Annotation Support for Testing</h4></div></div></div>

<p>As of Spring Framework 4.0, it is possible to use test-related annotations as
<a class="link" href="http://itmyhome.com/spring/beans.html#beans-meta-annotations" title="5.10.2&nbsp;Meta-annotations">meta-annotations</a> in order to create custom <span class="emphasis"><em>composed annotations</em></span>
and reduce configuration duplication across a test suite.</p>
<p>Each of the following may be used as meta-annotations in conjunction with the
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-framework" title="10.15.5&nbsp;Spring TestContext Framework">TestContext framework</a>.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">@ContextConfiguration</code>
</li><li class="listitem">
<code class="literal">@ContextHierarchy</code>
</li><li class="listitem">
<code class="literal">@ActiveProfiles</code>
</li><li class="listitem">
<code class="literal">@TestPropertySource</code>
</li><li class="listitem">
<code class="literal">@DirtiesContext</code>
</li><li class="listitem">
<code class="literal">@WebAppConfiguration</code>
</li><li class="listitem">
<code class="literal">@TestExecutionListeners</code>
</li><li class="listitem">
<code class="literal">@Transactional</code>
</li><li class="listitem">
<code class="literal">@BeforeTransaction</code>
</li><li class="listitem">
<code class="literal">@AfterTransaction</code>
</li><li class="listitem">
<code class="literal">@TransactionConfiguration</code>
</li><li class="listitem">
<code class="literal">@Rollback</code>
</li><li class="listitem">
<code class="literal">@Sql</code>
</li><li class="listitem">
<code class="literal">@SqlConfig</code>
</li><li class="listitem">
<code class="literal">@SqlGroup</code>
</li><li class="listitem">
<code class="literal">@Repeat</code>
</li><li class="listitem">
<code class="literal">@Timed</code>
</li><li class="listitem">
<code class="literal">@IfProfileValue</code>
</li><li class="listitem">
<code class="literal">@ProfileValueSourceConfiguration</code>
</li></ul></div>

<p>For example, if we discover that we are repeating the following configuration
across our JUnit-based test suite&#8230;</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderRepositoryTests { }

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserRepositoryTests { }</pre>

<p>We can reduce the above duplication by introducing a custom <span class="emphasis"><em>composed annotation</em></span>
that centralizes the common test configuration like this:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Target(ElementType.TYPE)</span></em>
<em><span class="hl-annotation" style="color: gray">@Retention(RetentionPolicy.RUNTIME)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({"/app-config.xml", "/test-data-access-config.xml"})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<em><span class="hl-annotation" style="color: gray">@Transactional</span></em>
<span class="hl-keyword">public</span> <em><span class="hl-annotation" style="color: gray">@interface</span></em> TransactionalDevTest { }</pre>

<p>Then we can use our custom <code class="literal">@TransactionalDevTest</code> annotation to simplify the
configuration of individual test classes as follows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@TransactionalDevTest</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderRepositoryTests { }

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@TransactionalDevTest</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> UserRepositoryTests { }</pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="testcontext-framework" href="#testcontext-framework"></a>10.15.5&nbsp;Spring TestContext Framework</h3></div></div></div>

<p>The <span class="emphasis"><em>Spring TestContext Framework</em></span> (located in the
<code class="literal">org.springframework.test.context</code> package) provides generic, annotation-driven unit and
integration testing support that is agnostic of the testing framework in use. The
TestContext framework also places a great deal of importance on <span class="emphasis"><em>convention over
configuration</em></span> with reasonable defaults that can be overridden through annotation-based
configuration.</p>
<p>In addition to generic testing infrastructure, the TestContext framework provides
explicit support for JUnit and TestNG in the form of <code class="literal">abstract</code> support classes. For
JUnit, Spring also provides a custom JUnit <code class="literal">Runner</code> that allows one to write so-called
<span class="emphasis"><em>POJO test classes</em></span>. POJO test classes are not required to extend a particular class
hierarchy.</p>
<p>The following section provides an overview of the internals of the TestContext
framework. If you are only interested in using the framework and not necessarily
interested in extending it with your own custom listeners or custom loaders, feel free
to go directly to the configuration (<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management" title="Context management">context management</a>,
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-fixture-di" title="Dependency injection of test fixtures">dependency injection</a>, <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-tx" title="Transaction management">transaction
management</a>), <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-support-classes" title="TestContext Framework support classes">support classes</a>, and
<a class="link" href="http://itmyhome.com/spring/aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;Annotations">annotation support</a> sections.</p>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-key-abstractions" href="#testcontext-key-abstractions"></a>Key abstractions</h4></div></div></div>

<p>The core of the framework consists of the <code class="literal">TestContext</code> and <code class="literal">TestContextManager</code> classes
and the <code class="literal">TestExecutionListener</code>, <code class="literal">ContextLoader</code>, and <code class="literal">SmartContextLoader</code> interfaces. A
<code class="literal">TestContextManager</code> is created on a per-test basis (e.g., for the execution of a single
test method in JUnit). The <code class="literal">TestContextManager</code> in turn manages a <code class="literal">TestContext</code> that
holds the context of the current test. The <code class="literal">TestContextManager</code> also updates the state
of the <code class="literal">TestContext</code> as the test progresses and delegates to <code class="literal">TestExecutionListener</code>s,
which instrument the actual test execution by providing dependency injection, managing
transactions, and so on. A <code class="literal">ContextLoader</code> (or <code class="literal">SmartContextLoader</code>) is responsible for
loading an <code class="literal">ApplicationContext</code> for a given test class. Consult the javadocs and the
Spring test suite for further information and examples of various implementations.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TestContext</code>: Encapsulates the context in which a test is executed, agnostic of the
actual testing framework in use, and provides context management and caching support
for the test instance for which it is responsible. The <code class="literal">TestContext</code> also delegates to
a <code class="literal">ContextLoader</code> (or <code class="literal">SmartContextLoader</code>) to load an <code class="literal">ApplicationContext</code> if
requested.
</li><li class="listitem">
<p class="simpara"><code class="literal">TestContextManager</code>: The main entry point into the <span class="emphasis"><em>Spring TestContext Framework</em></span>,
which manages a single <code class="literal">TestContext</code> and signals events to all registered
<code class="literal">TestExecutionListener</code>s at well-defined test execution points:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
prior to any <span class="emphasis"><em>before class methods</em></span> of a particular testing framework
</li><li class="listitem">
test instance preparation
</li><li class="listitem">
prior to any <span class="emphasis"><em>before methods</em></span> of a particular testing framework
</li><li class="listitem">
after any <span class="emphasis"><em>after methods</em></span> of a particular testing framework
</li><li class="listitem">
after any <span class="emphasis"><em>after class methods</em></span> of a particular testing framework
</li></ul></div>

</li><li class="listitem">
<code class="literal">TestExecutionListener</code>: Defines a <span class="emphasis"><em>listener</em></span> API for reacting to test execution
events published by the <code class="literal">TestContextManager</code> with which the listener is registered. See
<a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-tel-config" title="TestExecutionListener configuration">the section called &#8220;TestExecutionListener configuration&#8221;</a>.
</li><li class="listitem">
<p class="simpara"><code class="literal">ContextLoader</code>: Strategy interface introduced in Spring 2.5 for loading an
<code class="literal">ApplicationContext</code> for an integration test managed by the Spring TestContext
Framework.</p>
<p class="simpara">Implement <code class="literal">SmartContextLoader</code> instead of this interface in order to provide support for
annotated classes, active bean definition profiles, test property sources, context
hierarchies, and <code class="literal">WebApplicationContext</code>s.</p>
</li><li class="listitem">
<p class="simpara"><code class="literal">SmartContextLoader</code>: Extension of the <code class="literal">ContextLoader</code> interface introduced in Spring
3.1.</p>
<p class="simpara">The <code class="literal">SmartContextLoader</code> SPI supersedes the <code class="literal">ContextLoader</code> SPI that was introduced in
Spring 2.5. Specifically, a <code class="literal">SmartContextLoader</code> can choose to process resource
<code class="literal">locations</code>, annotated <code class="literal">classes</code>, or context <code class="literal">initializers</code>. Furthermore, a
<code class="literal">SmartContextLoader</code> can set active bean definition profiles and test property sources in
the context that it loads.</p>
<p class="simpara">Spring provides the following implementations:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem">
<code class="literal">DelegatingSmartContextLoader</code>: one of two default loaders which delegates internally
to an <code class="literal">AnnotationConfigContextLoader</code>, a <code class="literal">GenericXmlContextLoader</code>, or a
<code class="literal">GenericGroovyXmlContextLoader</code> depending either on the configuration declared for the
test class or on the presence of default locations or default configuration classes.
Groovy support is only enabled if Groovy is on the classpath.
</li><li class="listitem">
<code class="literal">WebDelegatingSmartContextLoader</code>: one of two default loaders which delegates
internally to an <code class="literal">AnnotationConfigWebContextLoader</code>, a <code class="literal">GenericXmlWebContextLoader</code>, or a
<code class="literal">GenericGroovyXmlWebContextLoader</code> depending either on the configuration declared for the
test class or on the presence of default locations or default configuration classes. A
web <code class="literal">ContextLoader</code> will only be used if <code class="literal">@WebAppConfiguration</code> is present on the test
class. Groovy support is only enabled if Groovy is on the classpath.
</li><li class="listitem">
<code class="literal">AnnotationConfigContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from
<span class="emphasis"><em>annotated classes</em></span>.
</li><li class="listitem">
<code class="literal">AnnotationConfigWebContextLoader</code>: loads a <code class="literal">WebApplicationContext</code> from <span class="emphasis"><em>annotated
classes</em></span>.
</li><li class="listitem">
<code class="literal">GenericGroovyXmlContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from <span class="emphasis"><em>resource
locations</em></span> that are either Groovy scripts or XML configuration files.
</li><li class="listitem">
<code class="literal">GenericGroovyXmlWebContextLoader</code>: loads a <code class="literal">WebApplicationContext</code> from <span class="emphasis"><em>resource
locations</em></span> that are either Groovy scripts or XML configuration files.
</li><li class="listitem">
<code class="literal">GenericXmlContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from XML <span class="emphasis"><em>resource
locations</em></span>.
</li><li class="listitem">
<code class="literal">GenericXmlWebContextLoader</code>: loads a <code class="literal">WebApplicationContext</code> from XML <span class="emphasis"><em>resource
locations</em></span>.
</li><li class="listitem">
<code class="literal">GenericPropertiesContextLoader</code>: loads a standard <code class="literal">ApplicationContext</code> from Java
Properties files.
</li></ul></div>

</li></ul></div>

<p>The following sections explain how to configure the TestContext framework through
annotations and provide working examples of how to write unit and integration tests with
the framework.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-tel-config" href="#testcontext-tel-config"></a>TestExecutionListener configuration</h4></div></div></div>

<p>Spring provides the following <code class="literal">TestExecutionListener</code> implementations that are registered
by default, exactly in this order.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">ServletTestExecutionListener</code>: configures Servlet API mocks for a
<code class="literal">WebApplicationContext</code>
</li><li class="listitem">
<code class="literal">DependencyInjectionTestExecutionListener</code>: provides dependency injection for the test
instance
</li><li class="listitem">
<code class="literal">DirtiesContextTestExecutionListener</code>: handles the <code class="literal">@DirtiesContext</code> annotation
</li><li class="listitem">
<code class="literal">TransactionalTestExecutionListener</code>: provides transactional test execution with
default rollback semantics
</li><li class="listitem">
<code class="literal">SqlScriptsTestExecutionListener</code>: executes SQL scripts configured via the <code class="literal">@Sql</code>
annotation
</li></ul></div>

<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-registering-tels" href="#testcontext-tel-config-registering-tels"></a>Registering custom TestExecutionListeners</h5></div></div></div>

<p>Custom <code class="literal">TestExecutionListener</code>s can be registered for a test class and its subclasses
via the <code class="literal">@TestExecutionListeners</code> annotation. See
<a class="link" href="http://itmyhome.com/spring/aop-api.html#integration-testing-annotations" title="10.15.4&nbsp;Annotations">annotation support</a> and the javadocs for
<code class="literal">@TestExecutionListeners</code> for details and examples.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-automatic-discovery" href="#testcontext-tel-config-automatic-discovery"></a>Automatic discovery of default TestExecutionListeners</h5></div></div></div>

<p>Registering custom <code class="literal">TestExecutionListener</code>s via <code class="literal">@TestExecutionListeners</code> is suitable
for custom listeners that are used in limited testing scenarios; however, it can become
cumbersome if a custom listener needs to be used across a test suite. To address this
issue, Spring Framework 4.1 supports automatic discovery of <span class="emphasis"><em>default</em></span>
<code class="literal">TestExecutionListener</code> implementations via the <code class="literal">SpringFactoriesLoader</code> mechanism.</p>
<p>Specifically, the <code class="literal">spring-test</code> module declares all core default
<code class="literal">TestExecutionListener</code>s under the
<code class="literal">org.springframework.test.context.TestExecutionListener</code> key in its
<code class="literal">META-INF/spring.factories</code> properties file. Third-party frameworks and developers can
contribute their own <code class="literal">TestExecutionListener</code>s to the list of default listeners in the
same manner via their own <code class="literal">META-INF/spring.factories</code> properties file.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-ordering" href="#testcontext-tel-config-ordering"></a>Ordering TestExecutionListeners</h5></div></div></div>

<p>When the TestContext framework discovers default <code class="literal">TestExecutionListeners</code> via the
aforementioned <code class="literal">SpringFactoriesLoader</code> mechanism, the instantiated listeners are sorted
using Spring&#8217;s <code class="literal">AnnotationAwareOrderComparator</code> which honors Spring&#8217;s <code class="literal">Ordered</code> interface
and <code class="literal">@Order</code> annotation for ordering. <code class="literal">AbstractTestExecutionListener</code> and all default
<code class="literal">TestExecutionListener</code>s provided by Spring implement <code class="literal">Ordered</code> with appropriate
values. Third-party frameworks and developers should therefore make sure that their
<span class="emphasis"><em>default</em></span> <code class="literal">TestExecutionListener</code>s are registered in the proper order by implementing
<code class="literal">Ordered</code> or declaring <code class="literal">@Order</code>. Consult the javadocs for the <code class="literal">getOrder()</code> methods of the
core default <code class="literal">TestExecutionListener</code>s for details on what values are assigned to each
core listener.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-tel-config-merging" href="#testcontext-tel-config-merging"></a>Merging TestExecutionListeners</h5></div></div></div>

<p>If a custom <code class="literal">TestExecutionListener</code> is registered via <code class="literal">@TestExecutionListeners</code>, the
<span class="emphasis"><em>default</em></span> listeners will not be registered. In most common testing scenarios, this
effectively forces the developer to manually declare all default listeners in addition to
any custom listeners. The following listing demonstrates this style of configuration.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestExecutionListeners({
    MyCustomTestExecutionListener.class,
    ServletTestExecutionListener.class,
    DependencyInjectionTestExecutionListener.class,
    DirtiesContextTestExecutionListener.class,
    TransactionalTestExecutionListener.class,
    SqlScriptsTestExecutionListener.class
})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>The challenge with this approach is that it requires that the developer know exactly
which listeners are registered by default. Moreover, the set of default listeners can
change from release to release&#8201;&#8212;&#8201;for example, <code class="literal">SqlScriptsTestExecutionListener</code> was
introduced in Spring Framework 4.1. Furthermore, third-party frameworks like Spring
Security register their own default <code class="literal">TestExecutionListener</code>s via the aforementioned
<a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-tel-config-automatic-discovery" title="Automatic discovery of default TestExecutionListeners">automatic discovery mechanism</a>.</p>
<p>To avoid having to be aware of and re-declare <span class="strong"><strong>all</strong></span> <span class="emphasis"><em>default</em></span> listeners, the
<code class="literal">mergeMode</code> attribute of <code class="literal">@TestExecutionListeners</code> can be set to
<code class="literal">MergeMode.MERGE_WITH_DEFAULTS</code>. <code class="literal">MERGE_WITH_DEFAULTS</code> indicates that locally declared
listeners should be merged with the default listeners. The merging algorithm ensures that
duplicates are removed from the list and that the resulting set of merged listeners is
sorted according to the semantics of <code class="literal">AnnotationAwareOrderComparator</code> as described in
<a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-tel-config-ordering" title="Ordering TestExecutionListeners">the section called &#8220;Ordering TestExecutionListeners&#8221;</a>. If a listener implements <code class="literal">Ordered</code> or is annotated
with <code class="literal">@Order</code> it can influence the position in which it is merged with the defaults;
otherwise, locally declared listeners will simply be appended to the list of default
listeners when merged.</p>
<p>For example, if the <code class="literal">MyCustomTestExecutionListener</code> class in the previous example
configures its <code class="literal">order</code> value (for example, <code class="literal">500</code>) to be less than the order of the
<code class="literal">ServletTestExecutionListener</code> (which happens to be <code class="literal">1000</code>), the
<code class="literal">MyCustomTestExecutionListener</code> can then be automatically merged with the list of
defaults <span class="emphasis"><em>in front of</em></span> the <code class="literal">ServletTestExecutionListener</code>, and the previous example could
be replaced with the following.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestExecutionListeners(
    listeners = MyCustomTestExecutionListener.class,
    mergeMode = MERGE_WITH_DEFAULTS,
)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
</div>
<div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="testcontext-ctx-management" href="#testcontext-ctx-management"></a>Context management</h4></div></div></div>

<p>Each <code class="literal">TestContext</code> provides context management and caching support for the test instance
it is responsible for. Test instances do not automatically receive access to the
configured <code class="literal">ApplicationContext</code>. However, if a test class implements the
<code class="literal">ApplicationContextAware</code> interface, a reference to the <code class="literal">ApplicationContext</code> is supplied
to the test instance. Note that <code class="literal">AbstractJUnit4SpringContextTests</code> and
<code class="literal">AbstractTestNGSpringContextTests</code> implement <code class="literal">ApplicationContextAware</code> and therefore
provide access to the <code class="literal">ApplicationContext</code> automatically.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: @Autowired ApplicationContext"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">@Autowired ApplicationContext</th></tr><tr><td align="left" valign="top">

<p>As an alternative to implementing the <code class="literal">ApplicationContextAware</code> interface, you can
inject the application context for your test class through the <code class="literal">@Autowired</code> annotation
on either a field or setter method. For example:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {

    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> ApplicationContext applicationContext;

    <span class="hl-comment">// class body...</span>
}</pre>

<p>Similarly, if your test is configured to load a <code class="literal">WebApplicationContext</code>, you can inject
the web application context into your test as follows:</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="strong"><strong>@WebAppConfiguration</strong></span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyWebAppTest {
    <span class="strong"><strong>@Autowired</strong></span>
    <span class="hl-keyword">private</span> WebApplicationContext wac;

    <span class="hl-comment">// class body...</span>
}</pre>

<p>Dependency injection via <code class="literal">@Autowired</code> is provided by the
<code class="literal">DependencyInjectionTestExecutionListener</code> which is configured by default (see
<a class="xref" href="http://itmyhome.com/spring/aop-api.html#testcontext-fixture-di" title="Dependency injection of test fixtures">the section called &#8220;Dependency injection of test fixtures&#8221;</a>).</p>
</td></tr></table></div>

<p>Test classes that use the TestContext framework do not need to extend any particular
class or implement a specific interface to configure their application context. Instead,
configuration is achieved simply by declaring the <code class="literal">@ContextConfiguration</code> annotation at
the class level. If your test class does not explicitly declare application context
resource <code class="literal">locations</code> or annotated <code class="literal">classes</code>, the configured <code class="literal">ContextLoader</code> determines
how to load a context from a default location or default configuration classes. In
addition to context resource <code class="literal">locations</code> and annotated <code class="literal">classes</code>, an application context
can also be configured via application context <code class="literal">initializers</code>.</p>
<p>The following sections explain how to configure an <code class="literal">ApplicationContext</code> via XML
configuration files, annotated classes (typically <code class="literal">@Configuration</code> classes), or context
initializers using Spring&#8217;s <code class="literal">@ContextConfiguration</code> annotation. Alternatively, you can
implement and configure your own custom <code class="literal">SmartContextLoader</code> for advanced use cases.</p>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-xml" href="#testcontext-ctx-management-xml"></a>Context configuration with XML resources</h5></div></div></div>

<p>To load an <code class="literal">ApplicationContext</code> for your tests using XML configuration files, annotate
your test class with <code class="literal">@ContextConfiguration</code> and configure the <code class="literal">locations</code> attribute with
an array that contains the resource locations of XML configuration metadata. A plain or
relative path&#8201;&#8212;&#8201;for example <code class="literal">"context.xml"</code>&#8201;&#8212;&#8201;will be treated as a classpath resource
that is relative to the package in which the test class is defined. A path starting with
a slash is treated as an absolute classpath location, for example
<code class="literal">"/org/example/config.xml"</code>. A path which represents a resource URL (i.e., a path
prefixed with <code class="literal">classpath:</code>, <code class="literal">file:</code>, <code class="literal">http:</code>, etc.) will be used <span class="emphasis"><em>as is</em></span>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from "/app-config.xml" and</span>
<span class="hl-comment">// "/test-config.xml" in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration(locations={"/app-config.xml", "/test-config.xml"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><code class="literal">@ContextConfiguration</code> supports an alias for the <code class="literal">locations</code> attribute through the
standard Java <code class="literal">value</code> attribute. Thus, if you do not need to declare additional
attributes in <code class="literal">@ContextConfiguration</code>, you can omit the declaration of the <code class="literal">locations</code>
attribute name and declare the resource locations by using the shorthand format
demonstrated in the following example.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="strong"><strong>@ContextConfiguration({"/app-config.xml", "/test-config.xml"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>If you omit both the <code class="literal">locations</code> and <code class="literal">value</code> attributes from the <code class="literal">@ContextConfiguration</code>
annotation, the TestContext framework will attempt to detect a default XML resource
location. Specifically, <code class="literal">GenericXmlContextLoader</code> and <code class="literal">GenericXmlWebContextLoader</code> detect
a default location based on the name of the test class. If your class is named
<code class="literal">com.example.MyTest</code>, <code class="literal">GenericXmlContextLoader</code> loads your application context from
<code class="literal">"classpath:com/example/MyTest-context.xml"</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.example;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from</span>
<span class="hl-comment">// "classpath:com/example/MyTest-context.xml"</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-groovy" href="#testcontext-ctx-management-groovy"></a>Context configuration with Groovy scripts</h5></div></div></div>

<p>To load an <code class="literal">ApplicationContext</code> for your tests using Groovy scripts that utilize the
<a class="link" href="http://itmyhome.com/spring/new-in-4.0.html#groovy-bean-definition-dsl" title="3.5&nbsp;Groovy DSL&#23450;&#20041;Bean">Groovy Bean Definition DSL</a>, annotate your test class with
<code class="literal">@ContextConfiguration</code> and configure the <code class="literal">locations</code> or <code class="literal">value</code> attribute with an array
that contains the resource locations of Groovy scripts. Resource lookup semantics for
Groovy scripts are the same as those described for <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-ctx-management-xml" title="Context configuration with XML resources">XML
configuration files</a>.</p>
<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Enabling Groovy script support"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Enabling Groovy script support</th></tr><tr><td align="left" valign="top">

<p>Support for using Groovy scripts to load an <code class="literal">ApplicationContext</code> in the Spring
TestContext Framework is enabled automatically if Groovy is on the classpath.</p>
</td></tr></table></div>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from "/AppConfig.groovy" and</span>
<span class="hl-comment">// "/TestConfig.groovy" in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration({"/AppConfig.groovy", "/TestConfig.Groovy"})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>If you omit both the <code class="literal">locations</code> and <code class="literal">value</code> attributes from the <code class="literal">@ContextConfiguration</code>
annotation, the TestContext framework will attempt to detect a default Groovy script.
Specifically, <code class="literal">GenericGroovyXmlContextLoader</code> and <code class="literal">GenericGroovyXmlWebContextLoader</code>
detect a default location based on the name of the test class. If your class is named
<code class="literal">com.example.MyTest</code>, the Groovy context loader will load your application context from
<code class="literal">"classpath:com/example/MyTestContext.groovy"</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.example;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from</span>
<span class="hl-comment">// "classpath:com/example/MyTestContext.groovy"</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Declaring XML config and Groovy scripts simultaneously"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Declaring XML config and Groovy scripts simultaneously</th></tr><tr><td align="left" valign="top">

<p>Both XML configuration files and Groovy scripts can be declared simultaneously via the
<code class="literal">locations</code> or <code class="literal">value</code> attribute of <code class="literal">@ContextConfiguration</code>. If the path to a configured
resource location ends with <code class="literal">.xml</code> it will be loaded using an <code class="literal">XmlBeanDefinitionReader</code>;
otherwise it will be loaded using a <code class="literal">GroovyBeanDefinitionReader</code>.</p>
<p>The following listing demonstrates how to combine both in an integration test.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from</span>
<span class="hl-comment">// "/app-config.xml" and "/TestConfig.groovy"</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration({ "/app-config.xml", "/TestConfig.groovy" })</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</td></tr></table></div>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-javaconfig" href="#testcontext-ctx-management-javaconfig"></a>Context configuration with annotated classes</h5></div></div></div>

<p>To load an <code class="literal">ApplicationContext</code> for your tests using <span class="emphasis"><em>annotated classes</em></span> (see
<a class="xref" href="http://itmyhome.com/spring/beans.html#beans-java" title="5.12&nbsp;Java-based container configuration">Section&nbsp;5.12, &#8220;Java-based container configuration&#8221;</a>), annotate your test class with <code class="literal">@ContextConfiguration</code> and configure the
<code class="literal">classes</code> attribute with an array that contains references to annotated classes.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from AppConfig and TestConfig</span>
<span class="strong"><strong>@ContextConfiguration(classes = {AppConfig.class, TestConfig.class})</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip: Annotated Classes"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Annotated Classes</th></tr><tr><td align="left" valign="top">

<p>The term <span class="emphasis"><em>annotated class</em></span> can refer to any of the following.</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
A class annotated with <code class="literal">@Configuration</code>
</li><li class="listitem">
A component (i.e., a class annotated with <code class="literal">@Component</code>, <code class="literal">@Service</code>, <code class="literal">@Repository</code>, etc.)
</li><li class="listitem">
A JSR-330 compliant class that is annotated with <code class="literal">javax.inject</code> annotations
</li><li class="listitem">
Any other class that contains <code class="literal">@Bean</code>-methods
</li></ul></div>

<p>Consult the javadocs of <code class="literal">@Configuration</code> and <code class="literal">@Bean</code> for further information regarding
the configuration and semantics of <span class="emphasis"><em>annotated classes</em></span>, paying special attention to
the discussion of <span class="emphasis"><em>`@Bean` Lite Mode</em></span>.</p>
</td></tr></table></div>

<p>If you omit the <code class="literal">classes</code> attribute from the <code class="literal">@ContextConfiguration</code> annotation, the
TestContext framework will attempt to detect the presence of default configuration
classes. Specifically, <code class="literal">AnnotationConfigContextLoader</code> and
<code class="literal">AnnotationConfigWebContextLoader</code> will detect all static inner classes of the test class
that meet the requirements for configuration class implementations as specified in the
<code class="literal">@Configuration</code> javadocs. In the following example, the <code class="literal">OrderServiceTest</code> class
declares a static inner configuration class named <code class="literal">Config</code> that will be automatically
used to load the <code class="literal">ApplicationContext</code> for the test class. Note that the name of the
configuration class is arbitrary. In addition, a test class can contain more than one
static inner configuration class if desired.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from the</span>
<span class="hl-comment">// static inner Config class</span>
<span class="strong"><strong>@ContextConfiguration</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OrderServiceTest {

    <em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
    <span class="hl-keyword">static</span> <span class="hl-keyword">class</span> Config {

        <span class="hl-comment">// this bean will be injected into the OrderServiceTest class</span>
        <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
        <span class="hl-keyword">public</span> OrderService orderService() {
            OrderService orderService = <span class="hl-keyword">new</span> OrderServiceImpl();
            <span class="hl-comment">// set properties, etc.</span>
            <span class="hl-keyword">return</span> orderService;
        }
    }

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> OrderService orderService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testOrderService() {
        <span class="hl-comment">// test the orderService</span>
    }

}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-mixed-config" href="#testcontext-ctx-management-mixed-config"></a>Mixing XML, Groovy scripts, and annotated classes</h5></div></div></div>

<p>It may sometimes be desirable to mix XML configuration files, Groovy scripts, and
annotated classes (i.e., typically <code class="literal">@Configuration</code> classes) to configure an
<code class="literal">ApplicationContext</code> for your tests. For example, if you use XML configuration in
production, you may decide that you want to use <code class="literal">@Configuration</code> classes to configure
specific Spring-managed components for your tests, or vice versa.</p>
<p>Furthermore, some third-party frameworks (like Spring Boot) provide first-class support
for loading an <code class="literal">ApplicationContext</code> from different types of resources simultaneously
(e.g., XML configuration files, Groovy scripts, and <code class="literal">@Configuration</code> classes). The Spring
Framework historically has not supported this for standard deployments. Consequently,
most of the <code class="literal">SmartContextLoader</code> implementations that the Spring Framework delivers in
the <code class="literal">spring-test</code> module support only one resource type per test context; however, this
does not mean that you cannot use both. One exception to the general rule is that the
<code class="literal">GenericGroovyXmlContextLoader</code> and <code class="literal">GenericGroovyXmlWebContextLoader</code> support both XML
configuration files and Groovy scripts simultaneously. Furthermore, third-party
frameworks may choose to support the declaration of both <code class="literal">locations</code> and <code class="literal">classes</code> via
<code class="literal">@ContextConfiguration</code>, and with the standard testing support in the TestContext
framework, you have the following options.</p>
<p>If you want to use resource locations (e.g., XML or Groovy) <span class="emphasis"><em>and</em></span> <code class="literal">@Configuration</code>
classes to configure your tests, you will have to pick one as the <span class="emphasis"><em>entry point</em></span>, and
that one will have to include or import the other. For example, in XML or Groovy scripts
you can include <code class="literal">@Configuration</code> classes via component scanning or define them as normal
Spring beans; whereas, in a <code class="literal">@Configuration</code> class you can use <code class="literal">@ImportResource</code> to
import XML configuration files. Note that this behavior is semantically equivalent to how
you configure your application in production: in production configuration you will define
either a set of XML or Groovy resource locations or a set of <code class="literal">@Configuration</code> classes
that your production <code class="literal">ApplicationContext</code> will be loaded from, but you still have the
freedom to include or import the other type of configuration.</p>
</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-initializers" href="#testcontext-ctx-management-initializers"></a>Context configuration with context initializers</h5></div></div></div>

<p>To configure an <code class="literal">ApplicationContext</code> for your tests using context initializers, annotate
your test class with <code class="literal">@ContextConfiguration</code> and configure the <code class="literal">initializers</code> attribute
with an array that contains references to classes that implement
<code class="literal">ApplicationContextInitializer</code>. The declared context initializers will then be used to
initialize the <code class="literal">ConfigurableApplicationContext</code> that is loaded for your tests. Note that
the concrete <code class="literal">ConfigurableApplicationContext</code> type supported by each declared
initializer must be compatible with the type of <code class="literal">ApplicationContext</code> created by the
<code class="literal">SmartContextLoader</code> in use (i.e., typically a <code class="literal">GenericApplicationContext</code>).
Furthermore, the order in which the initializers are invoked depends on whether they
implement Spring&#8217;s <code class="literal">Ordered</code> interface, are annotated with Spring&#8217;s <code class="literal">@Order</code> or the
standard <code class="literal">@Priority</code> annotation.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from TestConfig</span>
<span class="hl-comment">// and initialized by TestAppCtxInitializer</span>
<span class="strong"><strong>@ContextConfiguration(
    classes = TestConfig.class,
    initializers = TestAppCtxInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>It is also possible to omit the declaration of XML configuration files or annotated
classes in <code class="literal">@ContextConfiguration</code> entirely and instead declare only
<code class="literal">ApplicationContextInitializer</code> classes which are then responsible for registering beans
in the context&#8201;&#8212;&#8201;for example, by programmatically loading bean definitions from XML
files or configuration classes.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be initialized by EntireAppInitializer</span>
<span class="hl-comment">// which presumably registers beans in the context</span>
<span class="strong"><strong>@ContextConfiguration(initializers = EntireAppInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-inheritance" href="#testcontext-ctx-management-inheritance"></a>Context configuration inheritance</h5></div></div></div>

<p><code class="literal">@ContextConfiguration</code> supports boolean <code class="literal">inheritLocations</code> and <code class="literal">inheritInitializers</code>
attributes that denote whether resource locations or annotated classes and context
initializers declared by superclasses should be <span class="emphasis"><em>inherited</em></span>. The default value for
both flags is <code class="literal">true</code>. This means that a test class inherits the resource locations or
annotated classes as well as the context initializers declared by any superclasses.
Specifically, the resource locations or annotated classes for a test class are appended
to the list of resource locations or annotated classes declared by superclasses.
Similarly, the initializers for a given test class will be added to the set of
initializers defined by test superclasses. Thus, subclasses have the option
of <span class="emphasis"><em>extending</em></span> the resource locations, annotated classes, or context initializers.</p>
<p>If <code class="literal">@ContextConfiguration</code>'s <code class="literal">inheritLocations</code> or <code class="literal">inheritInitializers</code> attribute is
set to <code class="literal">false</code>, the resource locations or annotated classes and the context
initializers, respectively, for the test class <span class="emphasis"><em>shadow</em></span> and effectively replace the
configuration defined by superclasses.</p>
<p>In the following example that uses XML resource locations, the <code class="literal">ApplicationContext</code> for
<code class="literal">ExtendedTest</code> will be loaded from <span class="emphasis"><em>"base-config.xml"</em></span> <span class="emphasis"><em>and</em></span>
<span class="emphasis"><em>"extended-config.xml"</em></span>, in that order. Beans defined in <span class="emphasis"><em>"extended-config.xml"</em></span> may
therefore <span class="emphasis"><em>override</em></span> (i.e., replace) those defined in <span class="emphasis"><em>"base-config.xml"</em></span>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from "/base-config.xml"</span>
<span class="hl-comment">// in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration("/base-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-comment">// ApplicationContext will be loaded from "/base-config.xml" and</span>
<span class="hl-comment">// "/extended-config.xml" in the root of the classpath</span>
<span class="strong"><strong>@ContextConfiguration("/extended-config.xml")</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>Similarly, in the following example that uses annotated classes, the
<code class="literal">ApplicationContext</code> for <code class="literal">ExtendedTest</code> will be loaded from the <code class="literal">BaseConfig</code> <span class="emphasis"><em>and</em></span>
<code class="literal">ExtendedConfig</code> classes, in that order. Beans defined in <code class="literal">ExtendedConfig</code> may therefore
override (i.e., replace) those defined in <code class="literal">BaseConfig</code>.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from BaseConfig</span>
<span class="strong"><strong>@ContextConfiguration(classes = BaseConfig.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-comment">// ApplicationContext will be loaded from BaseConfig and ExtendedConfig</span>
<span class="strong"><strong>@ContextConfiguration(classes = ExtendedConfig.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}</pre>

<p>In the following example that uses context initializers, the <code class="literal">ApplicationContext</code> for
<code class="literal">ExtendedTest</code> will be initialized using <code class="literal">BaseInitializer</code> <span class="emphasis"><em>and</em></span>
<code class="literal">ExtendedInitializer</code>. Note, however, that the order in which the initializers are
invoked depends on whether they implement Spring&#8217;s <code class="literal">Ordered</code> interface, are annotated
with Spring&#8217;s <code class="literal">@Order</code> or the standard <code class="literal">@Priority</code> annotation.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be initialized by BaseInitializer</span>
<span class="strong"><strong>@ContextConfiguration(initializers = BaseInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}

<span class="hl-comment">// ApplicationContext will be initialized by BaseInitializer</span>
<span class="hl-comment">// and ExtendedInitializer</span>
<span class="strong"><strong>@ContextConfiguration(initializers = ExtendedInitializer.class)</strong></span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// class body...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-env-profiles" href="#testcontext-ctx-management-env-profiles"></a>Context configuration with environment profiles</h5></div></div></div>

<p>Spring 3.1 introduced first-class support in the framework for the notion of
environments and profiles (a.k.a., <span class="emphasis"><em>bean definition profiles</em></span>), and integration tests
can be configured to activate particular bean definition profiles for various testing
scenarios. This is achieved by annotating a test class with the <code class="literal">@ActiveProfiles</code>
annotation and supplying a list of profiles that should be activated when loading the
<code class="literal">ApplicationContext</code> for the test.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@ActiveProfiles</code> may be used with any implementation of the new <code class="literal">SmartContextLoader</code>
SPI, but <code class="literal">@ActiveProfiles</code> is not supported with implementations of the older
<code class="literal">ContextLoader</code> SPI.</p>
</td></tr></table></div>

<p>Let&#8217;s take a look at some examples with XML configuration and <code class="literal">@Configuration</code> classes.</p>
<pre class="programlisting"><span class="hl-comment">&lt;!-- app-config.xml --&gt;</span>
<span class="hl-tag">&lt;beans</span> <span class="hl-attribute">xmlns</span>=<span class="hl-value">"http://www.springframework.org/schema/beans"</span>
    <span class="hl-attribute">xmlns:xsi</span>=<span class="hl-value">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="hl-attribute">xmlns:jdbc</span>=<span class="hl-value">"http://www.springframework.org/schema/jdbc"</span>
    <span class="hl-attribute">xmlns:jee</span>=<span class="hl-value">"http://www.springframework.org/schema/jee"</span>
    <span class="hl-attribute">xsi:schemaLocation</span>=<span class="hl-value">"..."</span><span class="hl-tag">&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"transferService"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.service.internal.DefaultTransferService"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"accountRepository"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"feePolicy"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"accountRepository"</span>
            <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.repository.internal.JdbcAccountRepository"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;constructor-arg</span> <span class="hl-attribute">ref</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/bean&gt;</span>

    <span class="hl-tag">&lt;bean</span> <span class="hl-attribute">id</span>=<span class="hl-value">"feePolicy"</span>
        <span class="hl-attribute">class</span>=<span class="hl-value">"com.bank.service.internal.ZeroFeePolicy"</span><span class="hl-tag">/&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"dev"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/schema.sql"</span><span class="hl-tag">/&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/test-data.sql"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"production"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jee:jndi-lookup</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span> <span class="hl-attribute">jndi-name</span>=<span class="hl-value">"java:comp/env/jdbc/datasource"</span><span class="hl-tag">/&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

    <span class="hl-tag">&lt;beans</span> <span class="hl-attribute">profile</span>=<span class="hl-value">"default"</span><span class="hl-tag">&gt;</span>
        <span class="hl-tag">&lt;jdbc:embedded-database</span> <span class="hl-attribute">id</span>=<span class="hl-value">"dataSource"</span><span class="hl-tag">&gt;</span>
            <span class="hl-tag">&lt;jdbc:script</span>
                <span class="hl-attribute">location</span>=<span class="hl-value">"classpath:com/bank/config/sql/schema.sql"</span><span class="hl-tag">/&gt;</span>
        <span class="hl-tag">&lt;/jdbc:embedded-database&gt;</span>
    <span class="hl-tag">&lt;/beans&gt;</span>

<span class="hl-tag">&lt;/beans&gt;</span></pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<span class="hl-comment">// ApplicationContext will be loaded from "classpath:/app-config.xml"</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("/app-config.xml")</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> TransferService transferService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p>When <code class="literal">TransferServiceTest</code> is run, its <code class="literal">ApplicationContext</code> will be loaded from the
<code class="literal">app-config.xml</code> configuration file in the root of the classpath. If you inspect
<code class="literal">app-config.xml</code> you&#8217;ll notice that the <code class="literal">accountRepository</code> bean has a dependency on a
<code class="literal">dataSource</code> bean; however, <code class="literal">dataSource</code> is not defined as a top-level bean. Instead,
<code class="literal">dataSource</code> is defined three times: in the <span class="emphasis"><em>production</em></span> profile, the
<span class="emphasis"><em>dev</em></span> profile, and the <span class="emphasis"><em>default</em></span> profile.</p>
<p>By annotating <code class="literal">TransferServiceTest</code> with <code class="literal">@ActiveProfiles("dev")</code> we instruct the Spring
TestContext Framework to load the <code class="literal">ApplicationContext</code> with the active profiles set to
<code class="literal">{"dev"}</code>. As a result, an embedded database will be created and populated with test data,
and the <code class="literal">accountRepository</code> bean will be wired with a reference to the development
<code class="literal">DataSource</code>. And that&#8217;s likely what we want in an integration test.</p>
<p>It is sometimes useful to assign beans to a <code class="literal">default</code> profile. Beans within the default profile
are only included when no other profile is specifically activated. This can be used to define
<span class="emphasis"><em>fallback</em></span> beans to be used in the application&#8217;s default state. For example, you may
explicitly provide a data source for <code class="literal">dev</code> and <code class="literal">production</code> profiles, but define an in-memory
data source as a default when neither of these is active.</p>
<p>The following code listings demonstrate how to implement the same configuration and
integration test but using <code class="literal">@Configuration</code> classes instead of XML.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> StandaloneDataConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/schema.sql"</span>)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/test-data.sql"</span>)
            .build();
    }
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("production")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> JndiDataConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> DataSource dataSource() <span class="hl-keyword">throws</span> Exception {
        Context ctx = <span class="hl-keyword">new</span> InitialContext();
        <span class="hl-keyword">return</span> (DataSource) ctx.lookup(<span class="hl-string">"java:comp/env/jdbc/datasource"</span>);
    }
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<em><span class="hl-annotation" style="color: gray">@Profile("default")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> DefaultDataConfig {

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> DataSource dataSource() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.HSQL)
            .addScript(<span class="hl-string">"classpath:com/bank/config/sql/schema.sql"</span>)
            .build();
    }
}</pre>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@Configuration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceConfig {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em> DataSource dataSource;

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> TransferService transferService() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> DefaultTransferService(accountRepository(), feePolicy());
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> AccountRepository accountRepository() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> JdbcAccountRepository(dataSource);
    }

    <em><span class="hl-annotation" style="color: gray">@Bean</span></em>
    <span class="hl-keyword">public</span> FeePolicy feePolicy() {
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> ZeroFeePolicy();
    }

}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = {
        TransferServiceConfig.class,
        StandaloneDataConfig.class,
        JndiDataConfig.class,
        DefaultDataConfig.class})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> TransferService transferService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p>In this variation, we have split the XML configuration into four independent
<code class="literal">@Configuration</code> classes:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">TransferServiceConfig</code>: acquires a <code class="literal">dataSource</code> via dependency injection using
<code class="literal">@Autowired</code>
</li><li class="listitem">
<code class="literal">StandaloneDataConfig</code>: defines a <code class="literal">dataSource</code> for an embedded database suitable for
developer tests
</li><li class="listitem">
<code class="literal">JndiDataConfig</code>: defines a <code class="literal">dataSource</code> that is retrieved from JNDI in a production
environment
</li><li class="listitem">
<code class="literal">DefaultDataConfig</code>: defines a <code class="literal">dataSource</code> for a default embedded database in case
no profile is active
</li></ul></div>

<p>As with the XML-based configuration example, we still annotate <code class="literal">TransferServiceTest</code>
with <code class="literal">@ActiveProfiles("dev")</code>, but this time we specify all four configuration classes
via the <code class="literal">@ContextConfiguration</code> annotation. The body of the test class itself remains
completely unchanged.</p>
<p>It is often the case that a single set of profiles is used across multiple test classes
within a given project. Thus, to avoid duplicate declarations of the <code class="literal">@ActiveProfiles</code>
annotation it is possible to declare <code class="literal">@ActiveProfiles</code> once on a base class, and
subclasses will automatically inherit the <code class="literal">@ActiveProfiles</code> configuration from the base
class. In the following example, the declaration of <code class="literal">@ActiveProfiles</code> (as well as other
annotations) has been moved to an abstract superclass, <code class="literal">AbstractIntegrationTest</code>.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration(classes = {
        TransferServiceConfig.class,
        StandaloneDataConfig.class,
        JndiDataConfig.class,
        DefaultDataConfig.class})</span></em>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles("dev")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">abstract</span> <span class="hl-keyword">class</span> AbstractIntegrationTest {
}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" profile inherited from superclass</span>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    <span class="hl-keyword">private</span> TransferService transferService;

    <em><span class="hl-annotation" style="color: gray">@Test</span></em>
    <span class="hl-keyword">public</span> <span class="hl-keyword">void</span> testTransferService() {
        <span class="hl-comment">// test the transferService</span>
    }
}</pre>

<p><code class="literal">@ActiveProfiles</code> also supports an <code class="literal">inheritProfiles</code> attribute that can be used to
disable the inheritance of active profiles.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" profile overridden with "production"</span>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles(profiles = "production", inheritProfiles = false)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ProductionTransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {
    <span class="hl-comment">// test body</span>
}</pre>

<p><a name="testcontext-ctx-management-env-profiles-ActiveProfilesResolver" href="#testcontext-ctx-management-env-profiles-ActiveProfilesResolver"></a>Furthermore, it is sometimes necessary to resolve active profiles for tests
<span class="emphasis"><em>programmatically</em></span> instead of declaratively&#8201;&#8212;&#8201;for example, based on:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
the current operating system
</li><li class="listitem">
whether tests are being executed on a continuous integration build server
</li><li class="listitem">
the presence of certain environment variables
</li><li class="listitem">
the presence of custom class-level annotations
</li><li class="listitem">
etc.
</li></ul></div>

<p>To resolve active bean definition profiles programmatically, simply implement a custom
<code class="literal">ActiveProfilesResolver</code> and register it via the <code class="literal">resolver</code> attribute of
<code class="literal">@ActiveProfiles</code>. The following example demonstrates how to implement and register a
custom <code class="literal">OperatingSystemActiveProfilesResolver</code>. For further information, refer to the
corresponding javadocs.</p>
<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service;

<span class="hl-comment">// "dev" profile overridden programmatically via a custom resolver</span>
<em><span class="hl-annotation" style="color: gray">@ActiveProfiles(
    resolver = OperatingSystemActiveProfilesResolver.class,
    inheritProfiles = false)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> TransferServiceTest <span class="hl-keyword">extends</span> AbstractIntegrationTest {
    <span class="hl-comment">// test body</span>
}</pre>

<pre class="programlisting"><span class="hl-keyword">package</span> com.bank.service.test;

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> OperatingSystemActiveProfilesResolver <span class="hl-keyword">implements</span> ActiveProfilesResolver {

    <em><span class="hl-annotation" style="color: gray">@Override</span></em>
    String[] resolve(Class&lt;?&gt; testClass) {
        String profile = ...;
        <span class="hl-comment">// determine the value of profile based on the operating system</span>
        <span class="hl-keyword">return</span> <span class="hl-keyword">new</span> String[] {profile};
    }
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-property-sources" href="#testcontext-ctx-management-property-sources"></a>Context configuration with test property sources</h5></div></div></div>

<p>Spring 3.1 introduced first-class support in the framework for the notion of an
environment with a hierarchy of <span class="emphasis"><em>property sources</em></span>, and since Spring 4.1 integration
tests can be configured with test-specific property sources. In contrast to the
<code class="literal">@PropertySource</code> annotation used on <code class="literal">@Configuration</code> classes, the <code class="literal">@TestPropertySource</code>
annotation can be declared on a test class to declare resource locations for test
properties files or <span class="emphasis"><em>inlined</em></span> properties. These test property sources will be added to
the <code class="literal">Environment</code>'s set of <code class="literal">PropertySources</code> for the <code class="literal">ApplicationContext</code> loaded for the
annotated integration test.</p>
<div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top">
<p><code class="literal">@TestPropertySource</code> may be used with any implementation of the <code class="literal">SmartContextLoader</code>
SPI, but <code class="literal">@TestPropertySource</code> is not supported with implementations of the older
<code class="literal">ContextLoader</code> SPI.</p>
<p>Implementations of <code class="literal">SmartContextLoader</code> gain access to merged test property source values
via the <code class="literal">getPropertySourceLocations()</code> and <code class="literal">getPropertySourceProperties()</code> methods in
<code class="literal">MergedContextConfiguration</code>.</p>
</td></tr></table></div>

<p><span class="strong"><strong>Declaring test property sources</strong></span></p>
<p>Test properties files can be configured via the <code class="literal">locations</code> or <code class="literal">value</code> attribute of
<code class="literal">@TestPropertySource</code> as shown in the following example.</p>
<p>Both traditional and XML-based properties file formats are supported&#8201;&#8212;&#8201;for example,
<code class="literal">"classpath:/com/example/test.properties"</code> or <code class="literal">"file:///path/to/file.xml"</code>.</p>
<p>Each path will be interpreted as a Spring <code class="literal">Resource</code>. A plain path&#8201;&#8212;&#8201;for example,
<code class="literal">"test.properties"</code>&#8201;&#8212;&#8201;will be treated as a classpath resource that is <span class="emphasis"><em>relative</em></span> to the
package in which the test class is defined. A path starting with a slash will be treated
as an <span class="emphasis"><em>absolute</em></span> classpath resource, for example: <code class="literal">"/org/example/test.xml"</code>. A path which
references a URL (e.g., a path prefixed with <code class="literal">classpath:</code>, <code class="literal">file:</code>, <code class="literal">http:</code>, etc.) will
be loaded using the specified resource protocol. Resource location wildcards (e.g.
<code class="literal">**/*.properties</code>) are not permitted: each location must evaluate to exactly one
<code class="literal">.properties</code> or <code class="literal">.xml</code> resource.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestPropertySource("/test.properties")</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><span class="emphasis"><em>Inlined</em></span> properties in the form of key-value pairs can be configured via the
<code class="literal">properties</code> attribute of <code class="literal">@TestPropertySource</code> as shown in the following example. All
key-value pairs will be added to the enclosing <code class="literal">Environment</code> as a single test
<code class="literal">PropertySource</code> with the highest precedence.</p>
<p>The supported syntax for key-value pairs is the same as the syntax defined for entries in
a Java properties file:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">"key=value"</code>
</li><li class="listitem">
<code class="literal">"key:value"</code>
</li><li class="listitem">
<code class="literal">"key value"</code>
</li></ul></div>

<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestPropertySource(properties = {"timezone = GMT", "port: 4242"})</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><span class="strong"><strong>Default properties file detection</strong></span></p>
<p>If <code class="literal">@TestPropertySource</code> is declared as an empty annotation (i.e., without explicit
values for the <code class="literal">locations</code> or <code class="literal">properties</code> attributes), an attempt will be made to detect
a <span class="emphasis"><em>default</em></span> properties file relative to the class that declared the annotation. For
example, if the annotated test class is <code class="literal">com.example.MyTest</code>, the corresponding default
properties file is <code class="literal">"classpath:com/example/MyTest.properties"</code>. If the default cannot be
detected, an <code class="literal">IllegalStateException</code> will be thrown.</p>
<p><span class="strong"><strong>Precedence</strong></span></p>
<p>Test property sources have higher precedence than those loaded from the operating
system&#8217;s environment or Java system properties as well as property sources added by the
application declaratively via <code class="literal">@PropertySource</code> or programmatically. Thus, test property
sources can be used to selectively override properties defined in system and application
property sources. Furthermore, inlined properties have higher precedence than properties
loaded from resource locations.</p>
<p>In the following example, the <code class="literal">timezone</code> and <code class="literal">port</code> properties as well as any properties
defined in <code class="literal">"/test.properties"</code> will override any properties of the same name that are
defined in system and application property sources. Furthermore, if the
<code class="literal">"/test.properties"</code> file defines entries for the <code class="literal">timezone</code> and <code class="literal">port</code> properties those
will be overridden by the <span class="emphasis"><em>inlined</em></span> properties declared via the <code class="literal">properties</code> attribute.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@TestPropertySource(
    locations = "/test.properties",
    properties = {"timezone = GMT", "port: 4242"}
)</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> MyIntegrationTests {
    <span class="hl-comment">// class body...</span>
}</pre>

<p><span class="strong"><strong>Inheriting and overriding test property sources</strong></span></p>
<p><code class="literal">@TestPropertySource</code> supports boolean <code class="literal">inheritLocations</code> and <code class="literal">inheritProperties</code>
attributes that denote whether resource locations for properties files and inlined
properties declared by superclasses should be <span class="emphasis"><em>inherited</em></span>. The default value for both
flags is <code class="literal">true</code>. This means that a test class inherits the locations and inlined
properties declared by any superclasses. Specifically, the locations and inlined
properties for a test class are appended to the locations and inlined properties declared
by superclasses. Thus, subclasses have the option of <span class="emphasis"><em>extending</em></span> the locations and
inlined properties. Note that properties that appear later will <span class="emphasis"><em>shadow</em></span> (i.e..,
override) properties of the same name that appear earlier. In addition, the
aforementioned precedence rules apply for inherited test property sources as well.</p>
<p>If <code class="literal">@TestPropertySource</code>'s <code class="literal">inheritLocations</code> or <code class="literal">inheritProperties</code> attribute is set to
<code class="literal">false</code>, the locations or inlined properties, respectively, for the test class <span class="emphasis"><em>shadow</em></span>
and effectively replace the configuration defined by superclasses.</p>
<p>In the following example, the <code class="literal">ApplicationContext</code> for <code class="literal">BaseTest</code> will be loaded using
only the <code class="literal">"base.properties"</code> file as a test property source. In contrast, the
<code class="literal">ApplicationContext</code> for <code class="literal">ExtendedTest</code> will be loaded using the <code class="literal">"base.properties"</code>
<span class="strong"><strong>and</strong></span> <code class="literal">"extended.properties"</code> files as test property source locations.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@TestPropertySource("base.properties")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// ...</span>
}

<em><span class="hl-annotation" style="color: gray">@TestPropertySource("extended.properties")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// ...</span>
}</pre>

<p>In the following example, the <code class="literal">ApplicationContext</code> for <code class="literal">BaseTest</code> will be loaded using only
the <span class="emphasis"><em>inlined</em></span> <code class="literal">key1</code> property. In contrast, the <code class="literal">ApplicationContext</code> for <code class="literal">ExtendedTest</code> will be
loaded using the <span class="emphasis"><em>inlined</em></span> <code class="literal">key1</code> and <code class="literal">key2</code> properties.</p>
<pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@TestPropertySource(properties = "key1 = value1")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> BaseTest {
    <span class="hl-comment">// ...</span>
}

<em><span class="hl-annotation" style="color: gray">@TestPropertySource(properties = "key2 = value2")</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> ExtendedTest <span class="hl-keyword">extends</span> BaseTest {
    <span class="hl-comment">// ...</span>
}</pre>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-web" href="#testcontext-ctx-management-web"></a>Loading a WebApplicationContext</h5></div></div></div>

<p>Spring 3.2 introduced support for loading a <code class="literal">WebApplicationContext</code> in integration
tests. To instruct the TestContext framework to load a <code class="literal">WebApplicationContext</code> instead
of a standard <code class="literal">ApplicationContext</code>, simply annotate the respective test class with
<code class="literal">@WebAppConfiguration</code>.</p>
<p>The presence of <code class="literal">@WebAppConfiguration</code> on your test class instructs the TestContext
framework (TCF) that a <code class="literal">WebApplicationContext</code> (WAC) should be loaded for your
integration tests. In the background the TCF makes sure that a <code class="literal">MockServletContext</code> is
created and supplied to your test&#8217;s WAC. By default the base resource path for your
<code class="literal">MockServletContext</code> will be set to <span class="emphasis"><em>"src/main/webapp"</em></span>. This is interpreted as a path
relative to the root of your JVM (i.e., normally the path to your project). If you&#8217;re
familiar with the directory structure of a web application in a Maven project, you&#8217;ll
know that <span class="emphasis"><em>"src/main/webapp"</em></span> is the default location for the root of your WAR. If you
need to override this default, simply provide an alternate path to the
<code class="literal">@WebAppConfiguration</code> annotation (e.g., <code class="literal">@WebAppConfiguration("src/test/webapp")</code>). If
you wish to reference a base resource path from the classpath instead of the file
system, just use Spring&#8217;s <span class="emphasis"><em>classpath:</em></span> prefix.</p>
<p>Please note that Spring&#8217;s testing support for <code class="literal">WebApplicationContexts</code> is on par with
its support for standard <code class="literal">ApplicationContexts</code>. When testing with a
<code class="literal">WebApplicationContext</code> you are free to declare either XML configuration files or
<code class="literal">@Configuration</code> classes via <code class="literal">@ContextConfiguration</code>. You are of course also free to use
any other test annotations such as <code class="literal">@TestExecutionListeners</code>,
<code class="literal">@TransactionConfiguration</code>, <code class="literal">@ActiveProfiles</code>, etc.</p>
<p>The following examples demonstrate some of the various configuration options for loading
a <code class="literal">WebApplicationContext</code>.</p>
<p>
<b>Conventions.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>

<span class="hl-comment">// defaults to "file:src/main/webapp"</span>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>

<span class="hl-comment">// detects "WacTests-context.xml" in same package</span>
<span class="hl-comment">// or static nested @Configuration class</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p>

</p>

<p>The above example demonstrates the TestContext framework&#8217;s support for <span class="emphasis"><em>convention over
configuration</em></span>. If you annotate a test class with <code class="literal">@WebAppConfiguration</code> without
specifying a resource base path, the resource path will effectively default
to <span class="emphasis"><em>"file:src/main/webapp"</em></span>. Similarly, if you declare <code class="literal">@ContextConfiguration</code> without
specifying resource <code class="literal">locations</code>, annotated <code class="literal">classes</code>, or context <code class="literal">initializers</code>, Spring
will attempt to detect the presence of your configuration using conventions
(i.e., <span class="emphasis"><em>"WacTests-context.xml"</em></span> in the same package as the <code class="literal">WacTests</code> class or static
nested <code class="literal">@Configuration</code> classes).</p>
<p>
<b>Default resource semantics.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>

<span class="hl-comment">// file system resource</span>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration("webapp")</span></em>

<span class="hl-comment">// classpath resource</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("/spring/test-servlet-config.xml")</span></em>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p>

</p>

<p>This example demonstrates how to explicitly declare a resource base path with
<code class="literal">@WebAppConfiguration</code> and an XML resource location with <code class="literal">@ContextConfiguration</code>. The
important thing to note here is the different semantics for paths with these two
annotations. By default, <code class="literal">@WebAppConfiguration</code> resource paths are file system based;
whereas, <code class="literal">@ContextConfiguration</code> resource locations are classpath based.</p>
<p>
<b>Explicit resource semantics.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@RunWith(SpringJUnit4ClassRunner.class)</span></em>

<span class="hl-comment">// classpath resource</span>
<em><span class="hl-annotation" style="color: gray">@WebAppConfiguration("classpath:test-web-resources")</span></em>

<span class="hl-comment">// file system resource</span>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration("file:src/main/webapp/WEB-INF/servlet-config.xml")</span></em>

<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {
    <span class="hl-comment">//...</span>
}</pre><p>

</p>

<p>In this third example, we see that we can override the default resource semantics for
both annotations by specifying a Spring resource prefix. Contrast the comments in this
example with the previous example.</p>
<p>To provide comprehensive web testing support, Spring 3.2 introduced a
<code class="literal">ServletTestExecutionListener</code> that is enabled by default. When testing against a
<code class="literal">WebApplicationContext</code> this <a class="link" href="http://itmyhome.com/spring/aop-api.html#testcontext-key-abstractions" title="Key abstractions">TestExecutionListener</a> sets
up default thread-local state via Spring Web&#8217;s <code class="literal">RequestContextHolder</code> before each test
method and creates a <code class="literal">MockHttpServletRequest</code>, <code class="literal">MockHttpServletResponse</code>, and
<code class="literal">ServletWebRequest</code> based on the base resource path configured via
<code class="literal">@WebAppConfiguration</code>. <code class="literal">ServletTestExecutionListener</code> also ensures that the
<code class="literal">MockHttpServletResponse</code> and <code class="literal">ServletWebRequest</code> can be injected into the test
instance, and once the test is complete it cleans up thread-local state.</p>
<p>Once you have a <code class="literal">WebApplicationContext</code> loaded for your test you might find that you
need to interact with the web mocks&#8201;&#8212;&#8201;for example, to set up your test fixture or to
perform assertions after invoking your web component. The following example demonstrates
which mocks can be autowired into your test instance. Note that the
<code class="literal">WebApplicationContext</code> and <code class="literal">MockServletContext</code> are both cached across the test suite;
whereas, the other mocks are managed per test method by the
<code class="literal">ServletTestExecutionListener</code>.</p>
<p>
<b>Injecting mocks.&nbsp;</b>

</p><pre class="programlisting"><em><span class="hl-annotation" style="color: gray">@WebAppConfiguration</span></em>
<em><span class="hl-annotation" style="color: gray">@ContextConfiguration</span></em>
<span class="hl-keyword">public</span> <span class="hl-keyword">class</span> WacTests {

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    WebApplicationContext wac; <span class="hl-comment">// cached</span>

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockServletContext servletContext; <span class="hl-comment">// cached</span>

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockHttpSession session;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockHttpServletRequest request;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    MockHttpServletResponse response;

    <em><span class="hl-annotation" style="color: gray">@Autowired</span></em>
    ServletWebRequest webRequest;

    <span class="hl-comment">//...</span>
}</pre><p>

</p>

</div>
<div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="testcontext-ctx-management-caching" href="#testcontext-ctx-management-caching"></a>Context caching</h5></div></div></div>

<p>Once the TestContext framework loads an <code class="literal">ApplicationContext</code> (or <code class="literal">WebApplicationContext</code>)
for a test, that context will be cached and reused for <span class="emphasis"><em>all</em></span> subsequent tests that
declare the same unique context configuration within the same test suite. To understand
how caching works, it is important to understand what is meant by <span class="emphasis"><em>unique</em></span> and <span class="emphasis"><em>test
suite</em></span>.</p>
<p>An <code class="literal">ApplicationContext</code> can be <span class="emphasis"><em>uniquely</em></span> identified by the combination of
configuration parameters that are used to load it. Consequently, the unique combination
of configuration parameters are used to generate a <span class="emphasis"><em>key</em></span> under which the context is
cached. The TestContext framework uses the following configuration parameters to build
the context cache key:</p>
<div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
<code class="literal">locations</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">classes</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">contextInitializerClasses</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">contextLoader</code> <span class="emphasis"><em>(from @ContextConfiguration)</em></span>
</li><li class="listitem">
<code class="literal">parent</code> <span class="emphasis"><em>(from @ContextHierarchy)</em></span>
</li><li class="listitem">
<code class="literal">activeProfiles</code> <span class="emphasis"><em>(from @ActiveProfiles)</em></span>
</li><li class="listitem">
<code class="literal">propertySourceLocations</code> <span class="emphasis"><em>(from @TestPropertySource)</em></span>
</li><li class="listitem">
<code class="literal">propertySourceProperties</code> <span class="emphasis"><em>(from @TestPropertySource)</em></span>
</li><li class="listitem">
<code class="literal">resourceBasePath</code> <span class="emphasis"><em>(from @WebAppConfiguration)</em></span>
</li></ul></div>

<p>For example, if <code class="literal">TestClassA</code> specifies <code class="literal">{"app-config.xml", "test-config.xml"}</code> for the
<code class="liter
